args:
- name: active_rapid7_instance
  required: true
- defaultValue: BULK, INCREMENTAL
  isArray: true
  name: type
  required: true
commonfields:
  id: DownloadFinishedRapid7ScanReportsForPANWIoTCloudV2
  version: -1
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    packName: ""
    prevname: ""
    propagationLabels:
    - all
    toServerVersion: ""
dockerimage: demisto/panw-iot:1.0.0.79918
enabled: true
engineinfo: {}
mainengineinfo: {}
name: DownloadFinishedRapid7ScanReportsForPANWIoTCloudV2
pswd: ""
runas: DBotWeakRole
runonce: false
script: |
  register_module_line('DownloadFinishedRapid7ScanReportsForPANWIoTCloudV2', 'start', __line__())


  from typing import Dict, Any
  import traceback

  USING_RAPID7_INSTANCE = demisto.args().get('active_rapid7_instance')
  TYPE = demisto.args().get('type')
  LIST_NAME = 'Rapid7LaunchedReportsV2-'+str(TYPE)+"-"+str(USING_RAPID7_INSTANCE)

  def get_cache_report_list():

      res = demisto.executeCommand('getList', {'listName': LIST_NAME})
      if (
          not isinstance(res, list)
          or 'Contents' not in res[0]
          or not isinstance(res[0]['Contents'], str)
          or res[0]['Contents'] in ['Item not found (8)','']
      ):
          return 'No launched Reports - Report Cache '+str(LIST_NAME)+' is Empty'

      report_ids = res[0]['Contents']
      report_id_list = [line.split(',') for line in report_ids.split('\n')]
      return get_finished_report_list(report_id_list[0])


  def get_finished_report_list(launched_report_list):
      # return_outputs('1-'+str(launched_report_list))
      finished_report_list = []
      incomplete_job = []
      report_map = {}
      report_job_map = {}
      for entry in launched_report_list:
          # return_outputs('2')
          csv_report_value, pdf_report_value = entry.split('|')
          # return_outputs('3')
          if '_' in csv_report_value:
              csv_report_id, csv_report_ip, csv_scan_id, csv_instance_id, csv_report_format = csv_report_value.split('_')
              report_map[csv_report_id] = {'ip':csv_report_ip, 'reportscanid':csv_scan_id, 'instanceid':csv_instance_id,'reportformat':csv_report_format}
              pdf_report_id, pdf_report_ip, pdf_scan_id, pdf_instance_id, pdf_report_format = pdf_report_value.split('_')
              report_map[pdf_report_id] = {'ip': pdf_report_ip, 'reportscanid': pdf_scan_id,
                                           'instanceid': pdf_instance_id, 'reportformat': pdf_report_format}
              csv_status=None
              pdf_status=None
              try:
                  csv_res = demisto.executeCommand("nexpose-get-report-status",{'report_id':csv_report_id,'instance_id':csv_instance_id,'using':USING_RAPID7_INSTANCE})
                  csv_report_status = csv_res[0]['Contents']

                  if isError(csv_res[0]):
                      raise Exception(csv_res[0]['Contents'])

                  csv_status = csv_report_status['status']
              except Exception as e:
                  return_error('Exception when getting csv report status for report ip' + csv_report_ip +  ' and the report id: '+ csv_report_id +':'+ str(e))

              try:
                  pdf_res = demisto.executeCommand("nexpose-get-report-status",{'report_id':pdf_report_id,'instance_id':pdf_instance_id,'using':USING_RAPID7_INSTANCE})
                  pdf_report_status = pdf_res[0]['Contents']

                  if isError(pdf_res[0]):
                      raise Exception(pdf_res[0]['Contents'])

                  pdf_status = pdf_report_status['status']
              except Exception as e:
                  return_error('Exception when getting csv report status for report ip' + pdf_report_ip +  ' and the report id: '+ pdf_report_id +':'+ str(e))

              try:
                  if csv_status == 'complete' and pdf_status == 'complete':

                      if csv_scan_id in report_job_map:
                          report_job_map[csv_scan_id].append({'ip':csv_report_ip,'id':csv_report_id,'scanid':csv_scan_id,'instanceid':csv_instance_id,'reportstatus':csv_status,'reportformat':csv_report_format})
                      else:
                          report_job_map[csv_scan_id] = [{'ip':csv_report_ip,'id':csv_report_id,'scanid':csv_scan_id,'instanceid':csv_instance_id,'reportstatus':csv_status,'reportformat':csv_report_format}]

                      if pdf_scan_id in report_job_map:
                          report_job_map[pdf_scan_id].append(
                              {'ip': pdf_report_ip, 'id': pdf_report_id, 'scanid': pdf_scan_id,
                               'instanceid': pdf_instance_id,
                               'reportstatus': pdf_status, 'reportformat': pdf_report_format})
                      else:
                          report_job_map[pdf_scan_id] = [
                              {'ip': pdf_report_ip, 'id': pdf_report_id, 'scanid': pdf_scan_id,
                               'instanceid': pdf_instance_id,
                               'reportstatus': pdf_status, 'reportformat': pdf_report_format}]
                  else:
                      if csv_status != 'complete':
                          return_outputs(f'csv report status for the report_id:{csv_report_id} and report_ip: {csv_report_ip} is incomplete, hence skipping the downloading for both csv and pdf')
                      if pdf_status != 'complete':
                          return_outputs(f'pdf report status for the report_id:{pdf_report_id} and report_ip: {pdf_report_ip} is incomplete, hence skipping the downloading for both csv and pdf')
                      incomplete_job.append(csv_scan_id)
                      continue
              except Exception as e:
                  return_error('Exception while processing the csv and pdf report data: '+ str(e))
      #return_outputs('report_job_map - '+ str(report_job_map))
      for scan_id in report_job_map:
          scan_data = report_job_map[scan_id]
          pdf_csv_entry = []
          status=True
          for data in scan_data:
              if data['reportstatus'] == 'complete':
                  report_cache_entry = data['id'] + "_" + data['ip'] + "_" + scan_id + "_" + data['instanceid']+ "_"+data['reportformat']
                  pdf_csv_entry.append(report_cache_entry)
              else:
                  status=False
          if status == True and len(pdf_csv_entry) == 2:
              demisto.executeCommand("PANWIoTLaunchedVulnerabilityScanCacheOperations",
                  {"name":LIST_NAME,"operation":"delete","value":pdf_csv_entry[0]+"|"+pdf_csv_entry[1]})
              demisto.executeCommand("PANWIoTLaunchedVulnerabilityScanCacheOperations",
                  {"name":LIST_NAME,"operation":"delete","value":pdf_csv_entry[1]+"|"+pdf_csv_entry[0]})

      # for scan_id in incomplete_job:
      #     del report_job_map[scan_id]

      return download_finished_reports_to_context(report_job_map, incomplete_job)


  def download_finished_reports_to_context(report_job_map, incomplete_reports):

      op_list = []
      index = 0
      result = {}
      report_list=[]
      for job, job_data in report_job_map.items():
          for entry in job_data:
              ip = entry['ip']
              _id = entry['id']
              instance_id=entry['instanceid']
              report_format=entry['reportformat']
              result[_id] = ip
              name='report_'+str(ip)+'_'+str(_id)
              report_list.append({'report_id':_id,'instance_id':instance_id,'format':report_format,'name':name})
              time.sleep(1)
      appendContext('Nexpose.reportInfoList', report_list)
      appendContext('PANWIoTCloud.finishedReports', report_job_map)
      return report_list



  def main():
      try:
          return_results(get_cache_report_list())
      except Exception as ex:
          demisto.error(traceback.format_exc())  # print the traceback
          return_error(f'Failed to execute DownloadFinishedRapid7ScanReportsforPANWIoTCloudV2. Error: {str(ex)}\n {traceback.format_exc()}')

  ''' ENTRY POINT '''
  if __name__ in ('__main__', '__builtin__', 'builtins'):
      main()

  register_module_line('DownloadFinishedRapid7ScanReportsForPANWIoTCloudV2', 'end', __line__())
scripttarget: 0
subtype: python3
tags: []
timeout: 100800h0m0s
type: python
