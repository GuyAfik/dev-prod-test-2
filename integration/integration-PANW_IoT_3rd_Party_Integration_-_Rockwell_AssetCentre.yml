category: Network Security
commonfields:
  id: PANW IoT 3rd Party Integration - Rockwell AssetCentre
  version: -1
configuration:
- display: SQL Server Host \ IP
  name: sql-server-host
  required: true
  type: 0
- defaultvalue: "1433"
  display: SQL Server Port
  name: sql-server-port
  required: true
  type: 0
- display: SQL Database
  name: sql-database-name
  required: true
  type: 0
- additionalinfo: For "Windows Authentication" provide the Username as Domain \ Username..
    For SQL Server Authentication provide the SQL Server Username.
  display: Username
  name: sql-username
  required: true
  type: 0
- display: Password
  name: sql-password
  required: true
  type: 4
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    packName: ""
    prevname: ""
    propagationLabels:
    - all
    toServerVersion: ""
detaileddescription: "## Rockwell AssetCentre Integration\n\n##### Please configure
  the instance by providing following mandatory details:\n\n- Name of the instance\n
  - SQL Server instance name or IP address\n- SQL Server Port\n-  SQL Server Database
  Name\n- SQL Username\n- SQL Password\n\n##### At a high level:\n- To test connection
  we are using python library pyodbc.\n- To assist in debugging, in case of a negative
  outcome, we will provide a meaningful error message to make it clear to the user
  what the issue is, such as credentials or permission issues.\n- If the user encounters
  the error \"Unable to connect. Server may be unavailable or doesn't exist,\" they
  should:-\n  - Check if the SQL Server Port, SQL Server instance name, or IP address
  is correct.\n  - Verify the server's availability where the AssetCentre database
  is present.\n \n\n## Test Configuration\n\nAfter providing the mandatory details,
  please test the configuration using the Test button.\n\n---"
display: PANW IoT 3rd Party Integration - Rockwell AssetCentre
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYEAAACDCAMAAABcOFepAAABI1BMVEX////OFT/MADTNADfMADDLAC3NDjzLACnMADLLACvNADj88PPjlaD35OfKACPdb4P00djkkaDvvcbssrzaYHfUNlj1gCbgfY/UOlvmmqjZW3P3m17++PrYVG3YYHP1fR7uci7qaTHmYDTUSmLrbDDhVDj45uj23OHiipnlXjXuusP1193vdSziVzfxxs7yeinKAB7dSjrpprLhgpPbRTvWNT3QH0fSLFDVMT3XTGjrrLfdbYLsnpTZPjzWMj3SJD7HAADIABL+8+35zLf2rIf1oHX2l1f5u5buahH1eAD2v6j2kUrzsJbqXxT82cTwpZHkURrrZhzfRR/64dfmWybpb0Ptk3rpl5LaNib1xrrmbU7ur63gTCrifH3kbFjfXlnZRVBSrawJAAASG0lEQVR4nO1caXsbt7WeFbOJw71DqkMntWyOQjasLhkPTcmu47TptXubOk7TJvc2bfP/f8XFdgDMRo4pKdTjB+8XcRYsc17gbABkGBoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoPFF/94Y9f/7oBf/rvU/fu48dXX7958zuGT6p4+9dT9++jx5/fv//0099icBZ+peLt/3x16v599PjLN08+Jajl4O0fT929jx/vvnmCUeKAy/+TT7gG6iSjxWm7+fHiL9/85skT4KA0Dd7+iWuga8cK4/5pO/qxAhOA8aRmGvzuV2+5EzQ/D0wM7+y0Xf048e7b3zBUORAa6NoNTQpPz4I7x7tvHz9+XM/Bm18zDRSxCaApuBdQAuopeMM10DC0TQmtiO4W77797PHjWg7e//Zv9I1o5CFTRatZ0CtgmUXHd7GTERxfvhYRrTSlv1P6u3PHLbTEu+8+w6jj4M3X7I2hY5sltKAg+jIowgtm1+kxPUxnMSl+dQsKayrdkUqD19S73lx5+Hc8u8sGWuPFd59//rnkQKHg/Z/pC9EoKMu/lSKKvEqh0EGrI7q4cWhp+04ZGPm0UmeAfw9ZV8PRXTbQFpQARkGRg/dPmAZamJUJ0I6CGgZME3lHULBF98AAY5UxcGOfjoEX3z19+lRwoKiib/5Bn6c3JQvQXhHVMmAi88MV0fg+GIgfBgMvfnpKUeHge6aBBqbVIP/DFAgGkI8RQin3w9Ma985A92QMvPjxv54qFAgOvv871UDpTdA0ARgFexURMIDO19PplKtd07QKvHWy+imRZp25uLgbBubFph4EA5gAjKeVafAt00CrfRPg8CwABrjIB5yC8IY/X17uUOx5sTVJirYhHT7K8QMvNi+6U+IgFhm47lIkyWXCsCGS7XT5VdIjL/FnXSb0aP3IJE05400PWnkIDPxACahy8P3/Ujl0Gy1AOwpKDBgTLscuvVpOPAuxO8gOzKEst7ackD9AtjsxSgzMPDsksK+ynWMTxOT+tWczsC5d0d9+Tr9k44kaLe+CO/0PgIEffvziiy+qHPz0fzQNscoPTQBGQbMiKjNwwYTg0xJTt0Av8mBmGEXi0YVRZGAKrnGwNs7YtHLJFErAY0M7fJV5ku1o7KhNhS6bcadn4J+EAMGBoOA7poG6+y2AQsGwqYESA6nJagyIAKYVP8nhX5+4hdtlBjogTR8Lt8fY8NeG4JcUwVcD9ppzTUoz8SLb5z8cOgtOzsD8x5cvVQo4Bz9RDdQ7aAEU0TWF8oKBSyNN086If/8WP1rGIK3QBskFU1JoJalBGBUGuCozQ6KdIuZg2Xj+pDJocTLD6LP+e/jnJSMjNJNp4tPSIanz9Az86yVBiYOf/k0meppUJwACVBiwbxpaiArC5O4oiokpnHHfNDS7yRacJJ9YzTE0YAf5OM/DuGgHuDixPqc2gQ18QuqSNkYvXSzTEWvAwh/DeoEmpPYlk3RA+nBqBqL45UuFA07CC/KoZ145JUEjOSWqFHgNIVZNRIYcm3xwh2sadEHkmHAKiMrIoIyTdFI8daI50VmCAfE4YLr8kvUrjIyhQ6kgL+I5x6No4nYtWFuuWsDaGKdnYBA/e8Yo+E/5URot17uiOZxITVOlwG3IM1QZQCOWmVtDRoBVywVM5HXNn7hrtSZ4IeLpCa6x8Fdw8WZMhm4vJ6/NYOATA8EtdMAK9GgBqglPzcCZ9+wZ46DCAMVyolgCT8kLbyoWwp/WN1GXlaCuO0gF8VTkmk0ClIvaqfaX4Azk3JRIxccl7QyZffDYmz6YaGdpGI+4rSBR4XR6yWqIjdMz8K/f//4Z46CeAamrS/LIKnK1GmICwUBoWWBv/ZzonXOupbknu+JKKRSiIIpEARgH6JEt9B4zzNZlSv7ioT2jRHSoTmIpKPCRfApOoRc9BAaeP6ccNDKQCreQ+nQCu7IaOsRAeNO/3IDysom3zhmAyaMywLkpTiuYA6CE5Kxjsyk8zwImQHrtrDb0Np1jF1XD9UAYcJ4/Zxw0MQAeHe5kwdQu3NLnHGKAfmMK0osz4anYCXuRO+8ICf1UEgVnAC3BbRIp7gUrmg/JEzxzqB2x++dIEMW1kHTmCK4eAAOJ84pT8DPcSiMC+cqSixoEBShEmG0YoMlQ4JOIhf9GOXuRfz9Rdn0uY3+p1gS+UDoMQJy8n3NYWqH6f82mE5qwAtTpBJtzoYK4uCdnwH/1inHwM9waxrZto5HgYM6VprssFr0s2eJ2DID9QPjrB4FkAzNtSaZBISFTdbBkPDDjfQrBNHHtxgKBntGRYQF1UoV35VQctgfBAOFAYYC61L5YK42QEFkBWWkStGMAFrpIyAoJCtO7zLJriPI8MmSBXRTkyQajSyagZCAKoRZuq7vKAh6pWRkdzNWaxzWUEjwQBl499/4Jt8CBgGs+BxxI/IiYoGTcWjIwBQVD1BCQaDkORH80zyCfmMi2sA/ll7ISC3CwuCm4VoZDmCoxtegXZEMcc7cb7TC2W4fMvZMzYFECnJ+liuEM5HC9pLoCIbDDO/gxLNrilgx0OANojC+2oVkC8lnQUXpSyY3yBUXcLzoilAlJe/5IFueRYgcoxhY4ZIbYIx99egZMTIB3o7g5VLDIEb1g9lLY4eg1LC+mxexQSwZEUs2b42fl5X/kDdhbnbBAQYWB1C7MGSMXfQmJ1klkvTH/tkV5ncOhAd0DYMB85ZJMjND7wyAMQ3QjLDEbszHEw2vvHJ4U4+K2DKz51KH2Nzr3FEkjNxdzMbpQ84KhZIBn41YxmAI6NkaiGmoa1mJ+Svu1MtU8F/KYnE/OgG3aWyzcqTMW9/CYSeWcSKzid0yQC+QU4+JGBr70KF5zQxLRpUfPi7f0cjWzAp8uZDnupBDzDS8c18dGwPLdABExbx1yZQWs/WHuW7SiL0mp9WvWihfnRC2l25hfX23kh023gWPZYWhbTjDh3YHekfExumJV/JI7thIb5akx37lo3PACG0zCDmeuEhsXbHETA0aHA1hN4Qa/jlbTTbebTBeVFYb5YnqGsR50qNCjOQPUM5/LikSlvBl5XVjXz67Pujfn3f61SHGpxaC+ufHLIbHx9CP70esYiHrTHNbVQXw4CpD5oaHThgGNfcAMdDpEFdYxkK5go6KMh7FnaMUwWNMQaQZuicT2O1SdN2ihATO2ARjILMEBktxVotpizcBRqGEgytT95QP68KKuLEYWaAZuiRoGNtghCAbiDeK+O40bIXaV2LMeaTJh2Pb2vAVYnY8o7tsnWW5pn8Zdfr0Zs06e7y11t6hhgGTcUCjeIFkEu3GXrRIX72Vg5PKEsN+0oF+o1aObscKrVt9wPHoe7ZP1iF/f+PTabvAL7wUNDLD0GAV+Ws5LK1Bs8T4GIkmU02LXJ/hYccuvOBZsudgMgQHIj5eTkPeJJgYUoW9RsKwtSyFt8T4GIB1HGFg3vwY4FQMjzyEItvfcroomBkicxjF1pZGeA8RAlnHxPga20lygFp93KgZWwwXBcLC31N2iiQHYiYORXYkYOIdQ3wtLi+T7GVip6YvgsC0+FQOnQCMDdle8s4UBv5TaXB5CErZ4DwM3ap5TbFs3lvx4JWMTDlsakoGAvCFU4HKddHezbiIzCkbGiuAb83W3293wXqWLpIvfUy1ONEzOdzMSyXRWDB3BAJqRduaiup6idZdT2uimttHouns+657d6nBnIwNyPcAQY1aJvyRBYqGrmYEIlgS4XEEyW88leE1D7NQKyEVALLXIduAbHutYOjU9xw5RGNqOl4MtuYlJmTgxbsjD0ApMokCm9AK/J5JyacIK2944ml7RVq/6ggETkeszbAdoda4HijKdosCnjVq4UXDJd7Tb3sxIWDu+N7vFmRKSlahlgG67LEFNRtsijQa8NDPA7TDi+X0f5McVmEcTYSnL8CMzKuabWDS4LGaW3S0bd8x5QaOxWNWMh4Y89e9yx76TC08gHLMtLDQ53lPWmMhu+pIvVEpnu2PWKNtkgy4molI7P56Cvu/25iTTLj0w2MGwK7+7UtfEkMjkw0byZidnyzfW8goE2XUMmLUMrMqrK8jpSQZMdakonKm7/NasanUNQtlspDJgVRioLOkgtlmBb3NSG7WPjx17LvY7r3OyTDIZU0xy+JR8XIB4wLvjbfl9fqPRwnLBWxvY0QDBRmsGOuUtxGT5ODKKC/TiSeE30aXduj34BxnIxOESeSQhVLb6FeC1CfXrgRApvJo5VmVfOiqh8qmF+0oYXQJfvvKWoODAiBxmgCzcYHHsYLsVlpgw/N0CA8XuiQvi0onTHshFoeBWZQCRU09lBi5ko6jQqGQAiXh0T9B6CH0HhcSDyDaoOtA+BE7Dxl0jisVngTMVRu0YsMkpvEuR/0PmKk3hJKDpzBUG/HxsyZXicAyiIcYJwkGUr9JoDfNBYQBtyWG/RZGBZSBLpQsoRVZIBQNWfr614K2jGcAfjrwd4SC9Hnv1x+bboLkLXAB0WZhLmZuMgwzweEDsoKOWcAV251oy4E7FsQzM23lqpLDTfSSzh2yT/EJZpt6XlYDNfValUWDAIa5WAvvMjvpPGRS9AJkoGNNl9F7X8Y+bCChsdIp5POxFkg0eF7dlgH8yBBJ8bZTsXQeRUUO4gY10RBiwCXUm9tOBooCThAcYmPFSRY1JKgFLTHVVBETdwiGlASv272jkG01z9wgOkNVIwIrNZjTu4SgIdIDb+xAG+HiGHPmZJSTQVXeT8fMHbKdDJhhIYcjyvRpJxRutZQCmKy+leIiw5Xutds6/zX/EGdBtIcjlcc5g57U/v8cJcJrDwpEwaBigw9nIKjJgNjLArSwc0uFHb8hE4iJjqUO+gZodR8h8YGDOvwZ8NUUr7mOA9wbCorWcvZwBNorgI27FAHYXmcPuOGd0LmUb+4Os8h4VJL6/hFg5rsfkB3vpahjYFocjCGPcjgGYA0Agd8gOMcAHhMMZmFbmAM8Y38UcIJoCwhR7wwbkehzUeL0fToCal1ZBbfFO1S5wqKyGgV1RkfNZFZ63YwBGM8TsM3luZB8DfGxbm0IpYovugwGuiGiLVpfV1Ru57awy7PSsR15fB/1I1aRFwqGvMgCnykw6Q2FWKWmE/QzAwQ/2/3Rgh+khBuDAAUvTd5T9xvfCgEKBaccjVve8j1pY5T1G2BB2GL8F4MVIHAgnEMLtpiu9+SoDUElITr3OYVs02XfbigFIXNkkgZapR6D2MTCA2GVCjvCL05vL+2IAbAFr1JtxnbnYHQoR9qogkZdGs8sNA0id+JJwgoPEpLLGKgNigQe5kwn0k+aLWjHQg2ZCfzIWn3mIATF7caOiVKgcf7trBsRAYy0FF9wCZUm4zyrvV0FifTiWb4FvhOPitOZofi0DA7HCI0vQTEwrBkRSo5C7OMjAoq7R5T0ygD+zkNMKtrDTdp03WuV9bigBOI7K0jcMfGKL+4VsazMDxqZydjaeKiI7wEBxh3GoMBAUGbgp5EabGr03BgqKyKQZqTUPtVejwKobrgdUkIyllD3RMPBpGuNCHpVx4eByJMe8XKU8iwuDIOSn6dsxYAxi0XuERtIX4kebBAOXxQHTLzZq8xP+98eAdEqht47Zh8OKlzWxMrIPELC6osbXF6ti9KbLNqFfEVvTDegWHdvNByki930a3l8E9JXXslRv5/os3YZC3x3xhm/Ye1dUGMOYXrB/dZTFdOO7y1Y5lhOPnvhAvt3jT+hrG4/8hoUcIzJp1xxYI+vNSPdYo44Djc5cpVG+pd6P7+a/xA7K/0wF+eEll146nAR26eGhBdLFGUNx7aYzZXeppcn6Fzkak8SkkbHb7F9O0J+FI/XZdEay1XY+moqvHbIifRrELPvsgnoRUb/Y9CrJSdkN/pqe8hrroZiiEevatNxomI/WYkv7tdqowT+mrw6yW6BCAZ7UXgKCXnZdxSofnAH3gDQ9PgV5dOFbNfrBWNVEAHYwghVJcgoF8jyHbIDGcVjV/Wvj0J2JVbjVuWO1UkEaR2JQ+68VQ+9C7J3ILh3X3RsJa9wKdYqIDPogl3vYF8f983SNdsjGDRy4+VoL/pfBcOK6Tg3cqxabPjXuBPPVsBbXv+RBTw0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ2ND8L/A6p93LjXSqglAAAAAElFTkSuQmCC
name: PANW IoT 3rd Party Integration - Rockwell AssetCentre
script:
  commands:
  - arguments:
    - defaultValue: "100"
      description: Number of rows to be fetched at once. Shouldn't be greater than
        1000.
      name: page_size_limit
      required: true
    - defaultValue: "0"
      description: Number of rows to be skipped.
      name: page_offset
      required: true
    - defaultValue: "0"
      description: Retrieve the updated assets at the specified time intervals.
      name: poll_interval
    - isArray: true
      name: attribute_list
    - isArray: true
      name: asset_type_list
    description: Retrieves assets information.
    name: get-all-asset-details
  dockerimage: demisto/genericsql:1.1.0.26235
  runonce: false
  script: |
    register_module_line('PANW IoT 3rd Party Integration - Rockwell AssetCentre', 'start', __line__())


    register_module_line("PANW IoT 3rd Party Integration - Rockwell AssetCentre", "start", __line__())
    from datetime import datetime, timedelta
    import json
    import re
    import traceback
    from typing import Any, Dict, List, Optional, Tuple, Union, cast

    import dateparser

    import pyodbc
    import urllib3


    # Disable insecure warnings
    urllib3.disable_warnings()

    """ CONSTANTS """

    SQL_DRIVER = "FreeTDS"
    # SQL_DRIVER = "{ODBC Driver 17 for SQL Server}"

    # SQL Query to get all assets details from SQL Server
    SQL_QUERY_GET_ALL_ASSET_DETAILS = """
                                    SELECT
                                    'AssetPath' = dbo.arch_GetAssetPath(AR.AssetId),
                                    'AssetName' = AR.AssetName,
                                    'AssetType' = CASE AR.AssetTypeId
                                                     WHEN '{RA_Drive}' THEN 'RA_Drive'
                                                     WHEN '{PLC_5_Processor}' THEN 'PLC-5_Processor'
                                                     WHEN '{PanelView}' THEN 'PanelView'
                                                     WHEN '{PanelView_Plus}' THEN 'PanelView_Plus'
                                                     WHEN '{Logix5000_Controller}' THEN 'Logix5000_Controller'
                                                     WHEN '{SLC_500_Processor}' THEN 'SLC_500_Processor'
                                                     WHEN '{MicroLogix_Processor}' THEN 'MicroLogix_Processor'
                                                     ELSE 'Unknown'
                                                  END,
                                    'Description' = AR.AssetDesc,
                                    'AddressingInfo' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{AddressingInfo}'),
                                    'DeviceName' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{DeviceName}'),
                                    'FirmwareRevision' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{FirmwareRevision}'),
                                    'HardwareRevision' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{HardwareRevision}'),
                                    'HardwareType' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{HardwareType}'),
                                    'Manufacturer' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{Manufacturer}'),
                                    'AssetNumber' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{AssetNumber}'),
                                    'Location' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{Location}'),
                                    'SerialNumber' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{SerialNumber}')
                                    FROM
                                        aos_AssetRelationships AR, aos_AssetCatalogItems ACI
                                    WHERE
                                        AR.AssetTypeId = ACI.AssetTypeId AND
                                        AR.AssetTypeId IN (SELECT AssetTypeId FROM aos_AssetCatalogPropertyDef WHERE PropertyId = '{Manufacturer}')
                                    ORDER BY
                                        AR.AssetName
                                    OFFSET
                                        {skip} ROWS
                                    FETCH NEXT
                                        {next} ROWS ONLY;
                                    """

    # SQL Query to get all assets details from SQL Server
    SQL_QUERY_GET_UPDATED_ASSET_DETAILS = """
                                        SELECT
                                        'AssetPath' = dbo.arch_GetAssetPath(AR.AssetId),
                                        'AssetName' = AR.AssetName,
                                        'AssetType' = CASE AR.AssetTypeId
                                                         WHEN '{RA_Drive}' THEN 'RA_Drive'
                                                         WHEN '{PLC_5_Processor}' THEN 'PLC-5_Processor'
                                                         WHEN '{PanelView}' THEN 'PanelView'
                                                         WHEN '{PanelView_Plus}' THEN 'PanelView_Plus'
                                                         WHEN '{Logix5000_Controller}' THEN 'Logix5000_Controller'
                                                         WHEN '{SLC_500_Processor}' THEN 'SLC_500_Processor'
                                                         WHEN '{MicroLogix_Processor}' THEN 'MicroLogix_Processor'
                                                         ELSE 'Unknown'
                                                      END,
                                        'Description' = AR.AssetDesc, -- Removed the extra space
                                        'AddressingInfo' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{AddressingInfo}'),
                                        'DeviceName' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{DeviceName}'),
                                        'FirmwareRevision' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{FirmwareRevision}'),
                                        'HardwareRevision' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{HardwareRevision}'),
                                        'HardwareType' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{HardwareType}'),
                                        'Manufacturer' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{Manufacturer}'),
                                        'AssetNumber' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{AssetNumber}'),
                                        'Location' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{Location}'),
                                        'SerialNumber' = (SELECT PropertyValue FROM aos_AssetProperties AP WHERE AP.AssetID = AR.AssetId AND AP.PropertyId = '{SerialNumber}')
                                    FROM
                                        aos_AssetRelationships AR, aos_AssetCatalogItems ACI
                                    WHERE
                                        AR.AssetTypeId = ACI.AssetTypeId AND
                                        AR.AssetId IN (
                                            SELECT AssetID
                                            FROM aos_AssetProperties
                                            WHERE AssetTypeId IN (
                                                    SELECT AssetTypeId
                                                    FROM aos_AssetCatalogPropertyDef
                                                    WHERE PropertyId = '{Manufacturer}'
                                                )
                                            GROUP BY AssetId
                                            HAVING MAX(LastUpdated) >= '{last_updated}'
                                        )
                                    ORDER BY
                                        AR.AssetName
                                    OFFSET {skip} ROWS
                                    FETCH NEXT {next} ROWS ONLY;
                                    """

    def is_ip_address(ip):
        """
        Test for valid ip address

        :type ip: ``str``
        :param ip: IP address in the form of 192.168.0.1

        :return: True/False
        :rtype: ``bool``
        """
        ip_regex = "^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])$"
        if(re.search(ip_regex, ip)):
            return True
        else:
            return False

    def get_ip_address(attribute_value):
        ip = ""
        byte_string = get_values_decoded(attribute_value)
        # Define a regex pattern for matching an IP address
        ip_pattern = re.compile(r"\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b")

        # Find all matches in the string
        matches = ip_pattern.findall(byte_string)

        # Print the matched IP addresses
        for match in matches:
            ip = match
        return ip

    def get_values_decoded(attribute_value):

        byte_string = attribute_value.encode("utf-8")
        # Convert bytes to string and remove extra escape characters
        byte_string = byte_string.decode("utf-8").replace("\\x00", "").replace("'", "")
        if byte_string.startswith("b"):
            byte_string = byte_string[1:]
        return byte_string

    def get_validated_device_list_for_reporting(device_list):
        devices = []
        ip = ""
        for device in device_list:
            data = {}
            ip = get_ip_address(device.get("AddressingInfo", ""))
            if ip and is_ip_address(ip):
                data["connect_evtContent.ip"] = ip
                data["display_firmwareVer"] = get_values_decoded(device.get("HardwareRevision", ""))
                data["display_hostname"] = get_values_decoded(device.get("DeviceName", ""))
                data["display_desc"] = device.get("Description", "")
                data["display_sn"] = get_values_decoded(device.get("SerialNumber", ""))
                data["display_vendor"] = get_values_decoded(device.get("Manufacturer", ""))
                data["display_location"] = get_values_decoded(device.get("Location", ""))
                data["display_model"] = device.get("AssetType", "")
                if data["display_model"] != "" and "_" in data["display_model"]:
                    data["display_model"] = data["display_model"].replace("_", " ")
                devices.append(data)
        return devices

    def get_datetime_before_minutes(minutes):

        current_time = datetime.now()
        time_difference = timedelta(minutes=minutes)
        result_time = current_time - time_difference
        # Format the result_time as a string
        formatted_result = result_time.strftime("%Y-%m-%d %H:%M:%S:%f")[:-3]
        return formatted_result

    def validate_and_create_map(field_list, mapping_list):
        field_map = {}
        for field in field_list:
            field_map[field] = next((item.get(field, None) for item in mapping_list if field in item), None)
        return field_map

    def prepare_sql_query(attribute_list, asset_type_list, page_offset, page_size_limit, last_updated=None):
        attribute_map = validate_and_create_map(["AddressingInfo", "Manufacturer", "DeviceName", "FirmwareRevision",
                                                "HardwareRevision", "HardwareType", "AssetNumber", "Location",
                                                "SerialNumber"], attribute_list)

        asset_type_map = validate_and_create_map(["RA_Drive", "PanelView", "PLC_5_Processor", "PanelView_Plus",
                                                "Logix5000_Controller", "SLC_500_Processor", "MicroLogix_Processor"],
                                                asset_type_list)
        query_format = SQL_QUERY_GET_UPDATED_ASSET_DETAILS if last_updated is not None else SQL_QUERY_GET_ALL_ASSET_DETAILS
        return query_format.format(
            AddressingInfo=attribute_map.get("AddressingInfo"),
            Manufacturer=attribute_map.get("Manufacturer"),
            DeviceName=attribute_map.get("DeviceName"),
            FirmwareRevision=attribute_map.get("FirmwareRevision"),
            HardwareRevision=attribute_map.get("HardwareRevision"),
            HardwareType=attribute_map.get("HardwareType"),
            AssetNumber=attribute_map.get("AssetNumber"),
            Location=attribute_map.get("Location"),
            SerialNumber=attribute_map.get("SerialNumber"),
            RA_Drive=asset_type_map.get("RA_Drive"),
            PanelView=asset_type_map.get("PanelView"),
            PLC_5_Processor=asset_type_map.get("PLC_5_Processor"),
            PanelView_Plus=asset_type_map.get("PanelView_Plus"),
            Logix5000_Controller=asset_type_map.get("Logix5000_Controller"),
            SLC_500_Processor=asset_type_map.get("SLC_500_Processor"),
            MicroLogix_Processor=asset_type_map.get("MicroLogix_Processor"),
            skip=page_offset,
            next=page_size_limit,
            last_updated=last_updated
        )

    def get_all_asset_details(connection_string, page_size_limit, page_offset, poll_interval, attribute_list, asset_type_list):
        """get-all-assets-details command: Returns results for SQL Query

        :type connection_string: ``string``
        :param connection_string: Connection string to connect SQL Server


        :return:
            A list of unique devices fetched from AssetCentre Database.

        :rtype: ``Union[Dict[str, Any],CommandResults]``
        """
        connection = None
        asset_list = []
        if poll_interval:
            last_updated = get_datetime_before_minutes(poll_interval)
            sql_query_to_pull_assets = prepare_sql_query(attribute_list, asset_type_list, page_offset, page_size_limit, last_updated)
        else:
            sql_query_to_pull_assets = prepare_sql_query(attribute_list, asset_type_list, page_offset, page_size_limit)
        try:
            connection = pyodbc.connect(connection_string)
            cursor = connection.cursor()
            cursor.execute(sql_query_to_pull_assets)
            data_from_query = cursor.fetchall()
            columns = [column[0] for column in cursor.description]
            if data_from_query:
                # Creates a list of named dictionary by zipping columns and data, also convert everything to string
                asset_list = [dict(zip(columns, map(str, device))) for device in data_from_query]
                # Running validations on fields
                asset_list = get_validated_device_list_for_reporting(asset_list)
        except Exception as ex:
            demisto.error(traceback.format_exc())
            raise Exception(f"Exception while getting assets from AssetCentre SQL Server. {str(ex)}")
        finally:
            if connection:
                close_connection(connection)
        return asset_list


    """ HELPER FUNCTIONS  """


    def create_connection_string(
        sql_server_host: str, sql_server_port: str, sql_db: str, sql_user: str, sql_pwd: str
    ) -> str:
        """
        Creates a connection string for the pyodbc connection to SQL Server

        :param sql_server_host: SQL Server Host\IP
        :param sql_server_port: SQL Server Port(Default 1433)
        :param sql_db: SQL Server Database name for a AssetCentre
        :param sql_user: SQL Server username
        :param sql_pwd: SQL Server password
        :return: str
        """

        connection_string = "DRIVER={%s};SERVER=%s,%s;DATABASE=%s;UID=%s;PWD=%s" % (
            SQL_DRIVER,
            sql_server_host,
            sql_server_port,
            sql_db,
            sql_user,
            sql_pwd,
        )
        return connection_string


    def close_connection(connection):
        """Perform cleanup functions
        closes the pyodbc connection that was opened to the server

        :param connection: pyodbc connection handler to SQL Server
        :return: void
        """
        connection.close()


    """ COMMAND FUNCTIONS """


    def handle_database_exception(e):
        error_messages = {
            "Forbidden": "Authorization Error: Make sure credentials are correctly set.",
            "Login timeout expired": "Login timeout expired: Make sure the configuration is correct.",
            "Adaptive Server is unavailable": "Error: Unable to connect. Server may be unavailable or does not exist.",
            "Login failed for user": "Error: Login failed. SQL Database, username, or password is incorrect.",
            "Network-related or instance-specific error": "Error: Unable to connect. Check server address and port."
        }

        error_message = str(e)
        for keyword, user_message in error_messages.items():
            if keyword in error_message:
                return user_message

        # If no match is found, raise the original exception
        raise e

    def test_module(connection_string: str) -> str:

        """
        Returning 'ok' indicates that the integration works like it is supposed to.
        Connection to the server is successful.
        Raises exceptions if something goes wrong.

        :param type: ``str``
        :param name: connection_string to create a connection string for pyodbc connect request.

        :return: 'ok' if test passed, anything else will fail the test.
        :rtype: ``str``
        """
        connection = None
        try:
            connection = pyodbc.connect(connection_string)

        except Exception as e:
            return handle_database_exception(e)
        finally:
            if connection:
                close_connection(connection)
        return "ok"


    """ MAIN FUNCTION """


    def main() -> None:
        """main function, parses params and runs command functions

        :return:
        :rtype:
        """

        sql_server_host = demisto.params().get("sql-server-host")
        sql_server_port = demisto.params().get("sql-server-port")
        sql_db = demisto.params().get("sql-database-name")
        sql_user = demisto.params().get("sql-username")
        sql_pwd = demisto.params().get("sql-password")

        demisto.debug(f"Command being called is {demisto.command()}")
        try:
            connection_string = create_connection_string(sql_server_host, sql_server_port, sql_db, sql_user, sql_pwd)

            if demisto.command() == "test-module":
                # This is the call made when pressing the integration Test button.
                result = test_module(connection_string)
                return_results(result)

            elif demisto.command() == "get-all-asset-details":
                # Defaulting it to 1000, even if user picks a huge number
                page_size_limit = int(demisto.args().get("page_size_limit"))
                if page_size_limit > 1000:
                    page_size_limit = 1000

                page_offset = int(demisto.args().get("page_offset"))
                poll_interval = int(demisto.args().get("poll_interval"))
                attribute_list = demisto.args().get("attribute_list")
                asset_type_list = demisto.args().get("asset_type_list")
                asset_list = get_all_asset_details(
                    connection_string, page_size_limit, page_offset, poll_interval, attribute_list, asset_type_list
                )
                return_info_to_output = {}
                return_info_to_output["Total Assets"] = len(asset_list)

                return_results(CommandResults(
                    readable_output=tableToMarkdown("Asset Report Summary:", return_info_to_output, removeNull=True),
                    outputs_prefix='rockwell-assetcentre-IoT.assets',
                    outputs=asset_list
                ))

        # Log exceptions and return errors
        except Exception as e:
            demisto.error(traceback.format_exc())  # the traceback
            return_error(f"Failed to execute {demisto.command()} command.\nError:\n{str(e)}")


    """ ENTRY POINT """

    if __name__ in ("__main__", "__builtin__", "builtins"):
        main()

    register_module_line("PANW IoT 3rd Party Integration - Rockwell AssetCentre", "end", __line__())

    register_module_line('PANW IoT 3rd Party Integration - Rockwell AssetCentre', 'end', __line__())
  subtype: python3
  type: python
sourcemoduleid: Rockwell AssetCentre
