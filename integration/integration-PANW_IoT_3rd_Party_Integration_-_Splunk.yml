category: Endpoint
commonfields:
  id: PANW IoT 3rd Party Integration - Splunk
  version: -1
configuration:
- display: Host - IP (x.x.x.x)
  name: host
  required: true
  type: 0
- display: Username
  name: authentication
  required: true
  type: 9
- defaultvalue: "8089"
  display: Port
  name: port
  required: true
  type: 0
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    packName: ""
    prevname: ""
    propagationLabels:
    - all
    toServerVersion: ""
description: Runs queries on Splunk servers.
display: PANW IoT 3rd Party Integration - Splunk
image: data:image/png;base64,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
name: PANW IoT 3rd Party Integration - Splunk
script:
  commands:
  - arguments:
    - description: path of the search url
      name: path
      required: true
    - defaultValue: "100"
      description: 'The maximum number of returned results per search. '
      name: count
    - description: Offset Value
      name: offset
    description: Returns the results of a previous Splunk search. You can use this
      command in conjunction with the splunk-job-create command.
    name: splunk-job-results
  - arguments:
    - description: ID of the job for which to get the status.
      name: sid
      required: true
    description: Returns the status of a job.
    name: splunk-job-status
    outputs:
    - contextPath: Splunk.Job.Status
      description: Status of the job.
      type: String
  - arguments:
    - description: Search term to query
      name: search
      required: true
    - description: earliest time to search
      name: earliest_time
    description: Searches the job
    name: splunk-search-jobs
    outputs:
    - contextPath: Splunk.Search.SID
      description: Search ID
      type: string
  - arguments:
    - description: Splunk Search ID
      name: sid
      required: true
    description: Deletes the splunk search job initiated
    name: splunk-search-job-delete
    outputs:
    - contextPath: Splunk.Delete.SID
  dockerimage: demisto/splunksdk:1.0.0.33029
  runonce: false
  script: |
    register_module_line('PANW IoT 3rd Party Integration - Splunk', 'start', __line__())


    import re
    import requests
    import json
    from requests.auth import HTTPBasicAuth

    def get_headers():
        headers = {}
        return headers

    def get_server_url():
        url = demisto.params()['host']
        port = demisto.params()['port']
        url = re.sub('/[\/]+$/', '', url)
        url = re.sub('\/$', '', url)
        return url+':'+port

    BASE_URL = get_server_url()
    SERVER_URL = BASE_URL + '/services'
    USERNAME = demisto.params()['authentication']['identifier']
    PASSWORD = demisto.params()['authentication']['password']
    VERIFY_SSL = not demisto.params().get('insecure', False)


    def get_list_response(url, method='get', headers={}, body={}, params={}):
        final_result = []
        while True:
            response = send_request(url, method=method, body=body, params=params, headers=headers)
            if not response:
                break
            if response.headers is not None and 'text/xml' in response.headers['Content-Type']:
                return json.loads(xml2json(response.text))
            elif response.headers is not None and 'json' in response.headers['Content-Type']:
                res = response.json()
                if 'results' in res and res['results'] is not None:
                    final_result = final_result + res['results']
                    if len(res['results']) > 0:

                        if 'init_offset' in res and res['init_offset'] > 0:
                            params['offset']=int(params['count'])+int(res['init_offset'])
                        else:
                            return final_result
                    else:
                        return final_result
                else:
                    return response.json()
        return final_result

    def send_request(url, method='get', body=None, params=None, headers=None, is_file=False):
        body = body if body is not None else {}
        params = params if params is not None else {}

        headers = headers if headers is not None else get_headers()
        try:
            res = requests.request(method, url, headers=headers, data=body, params=params, auth=HTTPBasicAuth(USERNAME, PASSWORD), verify=VERIFY_SSL)
        except Exception as e:
            raise Exception('Error while calling the api = '+ url +' and the error is : ' + str(e))
        if res.status_code < 200 or res.status_code >= 300:
            raise Exception('Got status code ' + str(
                res.status_code) + ' with url ' + str(url) + ' with body ' + str(res.content) + ' with headers ' + str(res.headers))

        return res if is_file is False else res.content

    def test_module():
        path='auth/login'
        headers={}
        data={}
        headers['Content-Type'] = 'application/x-www-form-urlencoded'
        data={}
        data['username'] = USERNAME
        data['password'] = PASSWORD
        url = '{}/{}'.format(SERVER_URL, path)
        response = get_list_response(url=url, method='post', body=data, headers=headers)
        demisto.info('SPLUNK_RES'+str(response))
        return response

    def search_jobs():
        path='search/jobs'
        search = demisto.args()['search']
        earliest_time = demisto.args()['earliest_time']
        headers={}
        headers['Content-Type'] = 'application/x-www-form-urlencoded'
        data={}
        data['search'] = search
        if earliest_time is not None:
            data['earliest_time'] = earliest_time
            data['latest_time'] = 'now'
        demisto.info('search jobs body params:'+str(data))
        url = '{}/{}'.format(SERVER_URL, path)
        response = get_list_response(url=url, method='post', body=data, headers=headers)
        return CommandResults(
            readable_output='got search job response',
            outputs_prefix='Splunk.Search.SID',
            outputs=response
        )

    def get_job_status():
        search_id = demisto.args()['sid']
        path='search/jobs/'+search_id
        url = '{}/{}'.format(SERVER_URL, path)
        response = get_list_response(url=url)
        return CommandResults(
            readable_output='search job status:',
            outputs_prefix='Splunk.Job.Status',
            outputs=response
        )


    def get_job_results():
        count = demisto.args()['count']
        offset = demisto.args()['offset']
        path = demisto.args()['path']
        if count is None:
            count='10000'
        if offset is None:
            offset='0'
        # path='search/jobs/'+search_id+'/results'
        url = '{}/{}'.format(BASE_URL, path)
        headers={}
        headers['Content-Type'] = 'application/x-www-form-urlencoded'
        params={}
        params['output_mode'] = 'json'
        params['count'] = count
        params['offset'] = offset

        # response = get_list_response(url=url, params=params, headers=headers)
        response = send_request(url=url, params=params, body={}, headers=headers)
        return json.dumps(response.json())

    def delete_job_results(sid):
        search_id = sid
        demisto.info('delete search_id: '+str(search_id))
        path='search/jobs/'+search_id
        url = '{}/{}'.format(SERVER_URL, path)
        params={}
        params['output_mode'] = 'json'
        response = send_request(url=url, method='delete', params=params, body={})
        return json.dumps(response.json())

    def main():  # pragma: no cover
        params = demisto.params()
        command = demisto.command()
        demisto.info('Command being called is {command}')

        try:
            if command == 'test-module':
                test_module()
                # delete_job_results()
                return_results('ok')
            elif command == 'splunk-search-job-delete':
                sid = demisto.args()['sid']
                return_results(delete_job_results(sid))
            elif command == 'splunk-search-jobs':
                return_results(search_jobs())
            elif command == 'splunk-job-status':
                return_results(get_job_status())
            elif command == 'splunk-job-results':
                return_results(get_job_results())

        except Exception as e:
            err_msg = 'Error in Splunk integration - '+ str(e)
            return_error(err_msg, error=e)


    if __name__ in ["__builtin__", "builtins", '__main__']:  # pragma: no cover
        main()

    register_module_line('PANW IoT 3rd Party Integration - Splunk', 'end', __line__())
  subtype: python2
  type: python
sourcemoduleid: Splunk
