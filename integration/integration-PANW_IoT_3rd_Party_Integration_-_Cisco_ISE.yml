category: Network Security
commonfields:
  id: PANW IoT 3rd Party Integration - Cisco ISE
  version: -1
configuration:
- display: Cisco ISE server URL (e.g., https://123.123.123.65)
  name: serverURL
  required: true
  type: 0
- display: Server port (e.g., 9060)
  name: serverPort
  required: false
  type: 0
- display: Cisco ISE username
  name: credentials
  required: true
  type: 9
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Monitor ISE Node URL
  name: sessionServerURL
  required: false
  type: 0
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    packName: ""
    prevname: ""
    propagationLabels:
    - all
    toServerVersion: ""
description: Next-generation secure network access.
detaileddescription: "The Cisco Identity Services Engine (ISE) offers a network-based
  approach for adaptable, trusted access everywhere, based on context. \nIt gives
  you intelligent, integrated protection through intent-based policy and compliance
  solutions. \n\n---\n[View Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/cisco-ise)"
display: PANW IoT 3rd Party Integration - Cisco ISE
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEkAAAAyCAYAAAAQlvbeAAAGx0lEQVR42u1Za2xURRTeOzPbYikPeWgRWx7y8JXwQ/3HDw2JxldMBDXGBIhiFF+AihDFhJDwA8KjElhLd/c+lkIRQhtRjPKIKIokCshD9s7c3S0FSgVFnilQlPW77ez2lr3VLs0uNt6TnGxzz8ycc78558w3tz5PPPHEE0888cQTTzz5T4lini5jYb6IBPaPy4c/svz4WKYfWqys/mNYtwGJ1tRNZypPUt38nFRxJdf+WDCxnmlmkhqHZ3cbkFgoGmEaT0KPMNUsyKkvwyRMN0WrP3N99wFJM8MSpDhTo7kFSecEfn6R/tZ4IHU3kJSTF4uZJl6hmrgvG5AUPT6QRaJTybLfR2bVnCPx4SitqUr5uZJsQKJqbAyLiFd9FaJP/pvzuvgc9Bs7sDqqix6dBQnAaraNquL7rPxFxJbWwyBe3VmQaFXMz3TBW2xBMT//JRU2y2VgJxB8n86DxDdK28Gs/Kn8R9mcv+o0SCrviWdHbZtf4ytzWPOiyL3v8MUysEa8QO8sQKqVtn3u68aKO/C3S877otMgabwIz+olSAF3+mAWdY2kaYeegoMGqlobSDDuzzVIROfT7MwkRnRmzkHad4rSDXVrWMg8Tqri47uSRZp0ftFviJJcg0Q1sd22Uc36IdcgsUqzH1rGOTlP78JRzivlImcKInkASRWbZVPfnnOQNN4P+pucF+wC3Td1uUhTgSEGXWNbJm2nsCPZgLRJNuBoZibx1kwK8Z0uIO2xbSiPrVk0bhukxhaQVB5yAemsbUPFXH8m0W3HJiNLLlJd7FAisUKnjXzZ+BzAuUxXWZuU2nraWZBomM9kutlMVyYqM/yFjsxj4egVUlu/IMMWjn4Ef1fop/UfdhYkpcok1OA1eN5MDGtyO9ta4YdtK2yX6MfRKV3jQ4Y1mEbMm9zvaKKUVNcVuJDJVC9L4KUz7dW8jCw9QdyzN1rmSl6D+xVaaWbYALgN0iHpb23GYbDGAhhWqTtB5YXYtNt9+RbZgCta05gnsFsst5fpuMJUgUwy0csso/t8Tyo/PZyFogHyTeOj+fBHIsfHoa8ElKW7R/k88cST/7XQtYlCNOk7QBVGM8O6uf2lNKrYXAXaE3a/+5dFPhDz74IOw0lT9M+XXDGAaeJOrDWE6ryg43Exmx+NxPgRYO89bhg4RKvrhWa5iBnCZrR/Qq9CT0Ofd1CBUnkLP+nX+evtj/QDJZi/ATZ5NcB8jFUCP5W5nJYPws82x9hmALXbt1IUt4uppqE/C/EVsDdA/5JxHcXYxcRI9M7v6bWsaQBTrT0AwQ74Wp3hAGmYDDQJkGal56+wCA2LzY45l6EXoEkltHd0uxff1jCJhfnVDD8gub6KeN/0mocvDGZVsShT3WICPdCtvT7twoD8lZgki5LSJ1hEvI/fl1AKS/FsggOkoTajlSDNbCsxMVTudJIaYiPIXn/7mgBONUZZuCOdHUq4bjiuP02Ol11HVfNlAPQmSrgSmZQGiYVFbRogne/F70yMm50mmlDMieSnzEL8Njhskrt5hKjWIPeRHYMEBl8GptySYQDsAPrGw3RVLIPV09XxeekX1OILOy59MSoFOjZrD10dK3LY+lKNR+U6l4gaL805SHD0UDrwsFjig2QFkhQarF/NdEdp6LyRRsSsa75+bkyVI0Ac2pEfZNf4tmwTUzLt/N10zFXWI7kHaV18XNqhYS24XpCUJacLmWHOha3e0WeSxDj8hmNDPktlAPpShxlAdfOZdEy6mOTydWF62l6dyP0tgFYfHtLSaFUbpFiMVB/rkz1IzheI+QH2E/JkRPnxXY4MWJgCj0ZiczqMqfLg3ehHV5GNSYD5HQ1y0lZuvDD1mQXaTLTYsPw07gCvcZweaJJiMvQx/D0Lp8jj/wYSCe4rpmHzAezwLZhXzHTrXvSSRll236bHreT3sJB5JU0RjNhyNPonMW8C+th8X6h1g8iGOoWtsbY4Trav4fsFgD8R6+1s62uiJn8UYMeZUpxocTh2pwDtQWqWIL2Xeu7XrFFy7AXoqfRcvCSJ1L/Yrilv+nUGelPShQI0+SqsNgpQe34EaMkxaXfTuBL4uTS/TLs6VoLgNTg/4wjkCnSyA6Qh0n4RIM1oA0nY/On8NS/RQMOJd9x7jvU01tqbOsGkWuBJvdoBqteVoT99kuJcUs9CI0S3Snw3QgDSrfZ/cZnewnIrqc4/AIca4biW9EZfmQZ9G/b7HeD1sjMOWg4NQZeghJ4l4Xp/x9wsOhbj5kKDyKJyGrEm+gIxlkEHDA6gxFsYVwENUFW8hrgG+TzxxBNPPPHEE0888eRGyN8R98jGg6pa+wAAAABJRU5ErkJggg==
name: PANW IoT 3rd Party Integration - Cisco ISE
script:
  commands:
  - arguments:
    - description: 'MAC address of the endpoint (format: 11:22:33:44:55:66).'
      name: macAddress
      required: true
    description: Returns an endpoint ID, by its MAC address.
    name: cisco-ise-get-endpoint-id
    outputs:
    - contextPath: Endpoint.ID
      description: Endpoint ID.
      type: string
    - contextPath: Endpoint.MACAddress
      description: Endpoint MAC address.
      type: string
  - arguments:
    - description: The ID of the endpoint for which to return details.
      name: endpointID
    - description: MAC address of the endpoint (format 11:22:33:44:55:66).
      name: macAddress
    description: Returns details for a specified endpoint.
    name: cisco-ise-get-endpoint-details
    outputs:
    - contextPath: CiscoISE.Endpoint.ID
      description: Endpoint ID.
      type: string
    - contextPath: CiscoISE.Endpoint.Description
      description: Endpoint description.
      type: string
    - contextPath: CiscoISE.Endpoint.MACAddress
      description: Endpoint MAC address.
      type: string
    - contextPath: CiscoISE.Endpoint.Group
      description: Endpoint group name
      type: string
    - contextPath: Endpoint.ID
      description: Endpoint ID.
      type: string
    - contextPath: Endpoint.MACAddress
      description: Endpoint MAC address.
      type: string
    - contextPath: CiscoISE.Endpoint.CustomAttributes
      description: Endpoint custom attributes.
      type: string
    - contextPath: CiscoISE.Endpoint.StaticGroupAssignment
      description: True if endpoint has static group assignment
      type: boolean
    - contextPath: CiscoISE.Endpoint.StaticProfileAssignment
      description: Whether th endpoint has a static profile assignment.
      type: boolean
    - contextPath: CiscoISE.Endpoint.User
      description: Profile of the user associated with the endpoint.
      type: string
  - arguments:
    - description: MAC address of the endpoint (format 11:22:33:44:55:66).
      name: macAddress
      required: true
    description: Re-authenticates an endpoint (Change of Authorization - CoA).
    name: cisco-ise-reauthenticate-endpoint
    outputs:
    - contextPath: CiscoISE.Endpoint.MACAddress
      description: MAC address of the endpoint.
      type: string
    - contextPath: CiscoISE.Endpoint.reauthenticateResult
      description: Re-authentication result.
      type: boolean
  - arguments: []
    description: Returns data for existing endpoints.
    name: cisco-ise-get-endpoints
    outputs:
    - contextPath: Endpoint.ID
      description: Endpoint ID.
      type: string
    - contextPath: Endpoint.MACAddress
      description: Endpoint MAC address.
      type: string
    - contextPath: CiscoISE.Endpoint.ID
      description: Endpoint ID.
      type: string
    - contextPath: CiscoISE.Endpoint.MACAddress
      description: Endpoint MAC address.
      type: string
  - arguments:
    - description: Endpoint ID.
      name: id
    - description: MAC address of the endpoint (format 11:22:33:44:55:66).
      name: macAddress
    - description: A CSV list of attributes, for example, "attributeName=firstAttribute,secondAttribute".
      name: attributeName
      required: true
    - description: A CSV list of attribute values, for example, "attributeValue=firstValue,secondValue".
      name: attributeValue
      required: true
    description: Updates the custom attributes of an endpoint.
    name: cisco-ise-update-endpoint-custom-attribute
  - arguments:
    - description: The group ID to assign to this endpoint, e.g. 1
      name: groupId
    - description: MAC address of the endpoint (format 11:22:33:44:55:66).
      name: macAddress
    - description: Endpoint ID of the endpoint to update.
      name: id
    - description: Name of the group to update for the endpoint.
      name: groupName
    description: Updates the group of an endpoint.
    name: cisco-ise-update-endpoint-group
  - arguments: []
    description: Retrieves a collection of endpoint identity groups.
    name: cisco-ise-get-groups
    outputs:
    - contextPath: CiscoISE.Group.Description
      description: The description of the endpoint identity groups.
      type: String
    - contextPath: CiscoISE.Group.ID
      description: The ID of the endpoint identity groups.
      type: String
    - contextPath: CiscoISE.Group.Name
      description: The name of the endpoint identity groups.
      type: String
  - arguments: []
    description: Return all Adaptive Network Control policies.
    name: cisco-ise-get-policies
    outputs:
    - contextPath: CiscoISE.Policy.Description
      description: The description of the ANC policy.
      type: String
    - contextPath: CiscoISE.Policy.ID
      description: The ID of the ANC policy.
      type: String
    - contextPath: CiscoISE.Policy.Name
      description: The name of the ANC policy.
      type: String
  - arguments:
    - description: The name of the ANC policy to return.
      name: policy_name
    description: Returns a single Adaptive Network Control policy.
    name: cisco-ise-get-policy
    outputs:
    - contextPath: CiscoISE.Policy.Action
      description: The action of the policy. Can be "QUARANTINE", "PORTBOUNCE", or
        "SHUTDOWN".
      type: String
    - contextPath: CiscoISE.Policy.ID
      description: The ID of the ANC policy.
      type: String
    - contextPath: CiscoISE.Policy.Link
      description: The link for the ANC policy (GUI).
      type: String
    - contextPath: CiscoISE.Policy.Name
      description: The name of the ANC policy.
      type: String
  - arguments:
    - auto: PREDEFINED
      description: The actions of the policy. Can be "QUARANTINE", "PORTBOUNCE", or
        "SHUTDOWN".
      name: policy_actions
      predefined:
      - QUARANTINE
      - PORTBOUNCE
      - SHUTDOWN
      required: true
    - description: The name of the new adaptive network control policy.
      name: policy_name
      required: true
    description: Creates an ANC policy.
    name: cisco-ise-create-policy
    outputs:
    - contextPath: CiscoISE.Policy.Action
      description: The actions of the ANC policy.
      type: String
    - contextPath: CiscoISE.Policy.Name
      description: The name of the new ANC policy.
      type: String
  - arguments:
    - description: 'The MAC address to which to apply the policy. '
      name: mac_address
      required: true
    - description: The name of the policy to assign to the endpoint.
      name: policy_name
      required: true
    description: Assigns an Adapative Network Control policy to an endpoint.
    name: cisco-ise-assign-policy
    outputs:
    - contextPath: CiscoISE.Endpoint.MACAddress
      description: The MAC address of the endpoint.
      type: String
    - contextPath: CiscoISE.Endpoint.PolicyName
      description: The policy name that was applied to the endpoint.
      type: String
  - arguments: []
    description: Returns all blacklisted endpoints.
    name: cisco-ise-get-blacklist-endpoints
    outputs:
    - contextPath: CiscoISE.Endpoint.ID
      description: The endpoint ID.
      type: String
    - contextPath: CiscoISE.Endpoint.Name
      description: The name of the endpoint.
      type: String
    - contextPath: CiscoISE.Endpoint.Description
      description: The endpoint description.
      type: String
    - contextPath: CiscoISE.Endpoint.Link
      description: The link for the endpoint.
      type: String
  - arguments:
    - description: 'MAC address of the endpoint (format: 11:22:33:44:55:66).'
      name: mac_address
      required: true
    - description: A list of custom attributes
      name: attributes_map
    description: Given a mac address and custom attribute list, a new Endpoint is
      created on Cisco ISE.
    name: cisco-ise-create-endpoint
    outputs:
    - contextPath: CiscoISE.Endpoint.MACAddress
      description: Mac address of the newly created Endpoint.
      type: string
  - arguments: []
    description: Returns data for all Cisco ISE nodes in the deployment.
    name: cisco-ise-get-nodes
    outputs:
    - contextPath: CiscoISE.NodesData
      description: Details of all deployment ISE nodes.
      type: unknown
  - arguments:
    - description: 'MAC address of the endpoint (format: 11:22:33:44:55:66).'
      name: mac_address
      required: true
    description: Returns an EndpointID using its name (Available on ISE 2.3 and later
      versions).
    name: cisco-ise-get-endpoint-id-by-name
    outputs:
    - contextPath: Endpoint.ID
      description: Endpoint ID.
      type: string
    - contextPath: Endpoint.MACAddress
      description: Endpoint MAC address.
      type: string
  - arguments:
    - description: The MAC address from which to remove the policy.
      name: mac_address
      required: true
    - description: The name of the policy to remove from the endpoint.
      name: policy_name
      required: true
    description: Removes an Adapative Network Control policy from an endpoint.
    name: cisco-ise-remove-policy
    outputs:
    - contextPath: CiscoISE.Endpoint.MACAddress
      description: The MAC address of the endpoint.
      type: string
    - contextPath: CiscoISE.Endpoint.PolicyName
      description: The policy name that was removed from the endpoint.
      type: string
  - arguments:
    - description: IP address to query in ISE platform.
      name: ip_address
      required: true
    description: Queries an IP address and returns its session data from an active
      endpoint.
    name: cisco-ise-get-session-data-by-ip
  - arguments:
    - description: DACL Name
      name: name
      required: true
    description: 'Return an dacl ID using its name '
    name: cisco-ise-get-dacl-id
    outputs:
    - contextPath: CiscoISE.Dacl.ID
      description: DACL id
  - arguments:
    - description: SGACL Name
      name: name
      required: true
    description: Return an SGACL ID using its name
    name: cisco-ise-get-sgacl-id
    outputs:
    - contextPath: CiscoISE.Sgacl.ID
      description: SGACL id
  - arguments:
    - description: Authorization Profile Name
      name: name
      required: true
    name: cisco-ise-get-authorization-profile-id
    outputs:
    - contextPath: CiscoISE.AuthProfile.ID
      description: Authorization profile id
  - arguments:
    - description: dacl name
      name: name
      required: true
    - description: dacl description
      name: description
    - description: dacl rules
      isArray: true
      name: content
      required: true
    description: Creates DACL
    name: cisco-ise-create-dacl
    outputs:
    - contextPath: CiscoISE.Create.DaclName
      description: Name of the Dacl
    - contextPath: CiscoISE.Create.DaclID
      description: ID of the Dacl
  - arguments:
    - description: Dacl id
      name: id
      required: true
    - description: Dacl Name
      name: name
      required: true
    - description: Dacl description
      name: description
    - description: Dacl Content
      isArray: true
      name: content
      required: true
    description: Updates Dacl
    name: cisco-ise-update-dacl
    outputs:
    - contextPath: CiscoISE.Update.DaclID
      description: Dacl id
    - contextPath: CiscoISE.Update.DaclName
      description: Dacl Name
  - arguments:
    - description: Name of the Authorization Profile
      name: name
      required: true
    - description: Other attributes of the authorization profile
      isArray: true
      name: content
      required: true
    description: Creates authorization profile
    name: cisco-ise-create-auth-profile
    outputs:
    - contextPath: CiscoISE.Create.AuthName
      description: Authorization Profile Name
  - arguments:
    - description: Authorization Profile ID
      name: id
      required: true
    - description: Name of the Authorization Profile
      name: name
      required: true
    - description: Other attributes of the Authorization Profile
      isArray: true
      name: content
      required: true
    description: Updates authorization profile
    name: cisco-ise-update-auth-profile
    outputs:
    - contextPath: CiscoISE.Create.AuthName
      description: Authorization Profile Name
    - contextPath: CiscoISE.Create.AuthID
      description: Authorization Profile ID
  - arguments:
    - description: Name of the sgacl
      name: name
      required: true
    - description: Sgacl description
      name: description
    - description: Sgacl contents
      isArray: true
      name: content
      required: true
    description: Creates Sgacl in ISE
    name: cisco-ise-create-sgacl
    outputs:
    - contextPath: CiscoISE.Create.SgaclID
      description: Sgacl ID
    - contextPath: CiscoISE.Create.SgaclName
      description: Sgacl Name
  - arguments:
    - description: ID of the sgacl
      name: id
      required: true
    - description: Name of the sgacl
      name: name
      required: true
    - description: Description of the sgacl
      name: description
    - description: Contents of the sgacl
      isArray: true
      name: content
      required: true
    description: Updates the Sgacl in ISE
    name: cisco-ise-update-sgacl
    outputs:
    - contextPath: CiscoISE.Update.SgaclID
      description: Sgacl ID
    - contextPath: CiscoISE.Update.SgaclName
      description: Sgacl Name
  - arguments:
    - description: Name of the security group
      name: name
      required: true
    description: Returns the security group ID if exists
    name: cisco-ise-get-sgt-id
    outputs:
    - contextPath: CiscoISE.Sgt.ID
      description: Security group ID
  - arguments:
    - description: Name of the security group
      name: name
      required: true
    - description: Description of the security group
      name: description
    description: Creates a security group
    name: cisco-ise-create-sgt
    outputs:
    - contextPath: CiscoISE.Create.SgtID
      description: Security group ID
    - contextPath: CiscoISE.Create.SgtName
      description: Security group Name
  - arguments:
    - description: Source SGT ID
      name: srcSgtID
      required: true
    - description: Destination SGT ID
      name: destSgtID
      required: true
    - description: 'List of Sgacl ID '
      isArray: true
      name: sgaclIDs
      required: true
    description: Creates matrix using src and dest sgt's and sgacl
    name: cisco-ise-create-egress-matrix
    outputs:
    - contextPath: CiscoISE.Create.EgressMatrixStatus
      description: Status of the Egress matrix created
  - arguments:
    - description: ID of the egress matrix entry
      name: id
      required: true
    - description: Source SGT ID
      name: srcSgtID
      required: true
    - description: Destination SGT ID
      name: destSgtID
    - description: List of Sgacl ID
      isArray: true
      name: sgaclIDs
      required: true
    - description: Default Rule
      name: defaultRule
    - description: Matrix Cell Status
      name: matrixCellStatus
    description: Updates the egress matrix using src and dest sgt's and sgacl
    name: cisco-ise-update-egress-matrix
    outputs:
    - contextPath: CiscoISE.Update.EgressMatrixID
      description: ID of the egress matrix entry
  - arguments:
    - description: Source SGT name
      name: sourceSgt
      required: true
    - description: Dest SGT name
      name: destSgt
      required: true
    description: Gets the egress matrix ID if exists
    name: cisco-ise-get-egress-matrix-id
    outputs:
    - contextPath: CiscoISE.Matrix.ID
      description: Egress Matrix ID
  - arguments:
    - description: Egress Matrix ID
      name: id
    description: Get Egress Matrix response
    name: cisco-ise-get-egress-matrix
    outputs:
    - contextPath: CiscoISE.Matrix.MatrixCellStatus
      description: Matrix cell status
    - contextPath: CiscoISE.Matrix.DefaultRule
      description: Matrix default rule
    - contextPath: CiscoISE.Matrix.Sgacls
      description: Matrix sgacls
  - arguments:
    - name: mac_address
      required: true
    description: 'Returns session information for a device based on its MAC '
    name: cisco-ise-mnt-get-session-by-mac
  - arguments:
    - name: profile_id
    description: Returns device profile from ISE using ERS API
    name: cisco-ise-get-ers-profile-by-id
  dockerimage: demisto/panw-iot:1.0.0.79918
  runonce: false
  script: |
    register_module_line('PANW IoT 3rd Party Integration - Cisco ISE', 'start', __line__())







    ''' IMPORTS '''
    import requests
    from urllib.parse import urlparse
    from requests.auth import HTTPBasicAuth
    import base64
    import xmltodict

    # disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    ''' GLOBAL VARS '''

    BASE_URL = re.sub(r"/+$", "", demisto.params().get('serverURL'))
    SERVER_PORT = demisto.params().get('serverPort')
    SERVER_URL = BASE_URL + ':' + SERVER_PORT
    SERVER_ADMIN_URL = BASE_URL

    MNT_URL = demisto.params().get('sessionServerURL')

    USERNAME = demisto.params().get('credentials').get('identifier')
    PASSWORD = demisto.params().get('credentials').get('password')

    USE_SSL = not demisto.params().get('insecure', False)

    DEFAULT_HEADERS = {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Connection': 'keep_alive',
    }

    DEFAULT_ADMIN_HEADERS = {
        'Content-Type': 'application/json',
        'Accept': 'application/xml',
        'Connection': 'keep_alive',
    }
    ''' HELPER FUNCTIONS '''

    def http_request(method, url_suffix, params=None, data=None, headers=None, is_admin_api=False, is_mnt_api=False):
        params = params if params is not None else {}
        if headers is None:
            headers = DEFAULT_ADMIN_HEADERS if is_admin_api else DEFAULT_HEADERS


        if is_admin_api:
            url = SERVER_ADMIN_URL + url_suffix
        elif is_mnt_api:
            mmt_b64 = base64.b64encode((USERNAME + ':' + PASSWORD).encode()).decode()
            url = MNT_URL + url_suffix
            headers = {
                'Authorization': 'Basic %s' % mmt_b64
            }
        else:
            url = SERVER_URL + url_suffix

        try:
            #print(f'running {method} request with url={url}')
            LOG(f'running {method} request with url={url}')

            if is_mnt_api:
                response = requests.request(
                    method,
                    url,
                    headers=headers,
                    verify=USE_SSL,
                    params=params,
                    data=data,
                    timeout=30
                )
            else:
                response = requests.request(
                    method,
                    url,
                    auth=HTTPBasicAuth(USERNAME, PASSWORD),
                    headers=headers,
                    verify=USE_SSL,
                    params=params,
                    data=data,
                    timeout=30
                )

        except requests.exceptions.SSLError:
            err_msg = 'Could not connect to Cisco ISE: Could not verify certificate.'
            return_error(err_msg)
        except requests.exceptions.ConnectionError:
            err_msg = 'Connection Error. Verify that the Server URL and port are correct, and that the port is open.'
            return_error(err_msg)

        if response.status_code not in {200, 201, 202, 204} and is_mnt_api:
            return_error(response.content)
        # handle request failure
        if response.status_code not in {200, 201, 202, 204}:
            message = parse_error_response(response)
            err_msg = f'Error in API call to Cisco ISE Integration [{response.status_code}] - {response.reason}, {message}, '+str(data)
            return_error(err_msg)

        if response.status_code in (201, 204):
            return

        if is_admin_api:
            return response.content
        try:
            if is_mnt_api:
                response = xmltodict.parse(response.content)
                return response
        except:
            return_error(response.content)
        try:
            response = response.json()
        except ValueError:
            return_error(response.content)

        return response


    def parse_error_response(response):
        try:
            res = response.json()
            msg = res.get('ERSResponse').get('messages')
            err = msg[0].get('title', '')
        except Exception:
            return response.text
        return err


    def translate_group_id(group_id):
        """
        Translates group ID to group name
        """

        api_endpoint = f"/ers/config/identitygroup/{group_id}"
        identity_group = http_request('GET', api_endpoint)['IdentityGroup']
        return identity_group['name']


    ''' COMMANDS FUNCTIONS '''


    def get_groups_request():

        api_endpoint = '/ers/config/endpointgroup'
        return http_request('GET', api_endpoint)


    def get_groups():
        """
        Retrieve a collection of endpoint identity groups.
        """

        groups_data: dict = get_groups_request().get('SearchResult', {})

        if groups_data.get('total', 0) < 1:
            return 'No groups were found.'

        groups = groups_data.get('resources', [])
        context = []
        humanreadable = []

        for group in groups:
            context_dict = {
                'ID': group.get('id'),
                'Name': group.get('name'),
                'Description': group.get('description')
            }
            hr_dict = dict(context_dict)
            context.append(context_dict)
            humanreadable.append(hr_dict)

        entry_context = {
            'CiscoISE.Group(val.ID === obj.ID)': context
        }

        return_outputs(tableToMarkdown('Cisco ISE Groups', humanreadable, ['ID', 'Name', 'Description'], removeNull=True),
                       entry_context, groups_data)


    def get_endpoint_id(mac_address=None):
        """
        Returns endpoint id by specific mac address
        """

        if mac_address is not None:
            api_endpoint = f'/ers/config/endpoint?filter=mac.EQ.{mac_address}'
        return http_request('GET', api_endpoint, '')


    def get_endpoint_id_command():
        """
        corresponds to 'cisco-ise-get-endpoint-id' command. Returns endpoint's id
        """
        mac_address = demisto.args().get('macAddress')

        if not is_mac_address(mac_address):
            return_error('Given MAC address is invalid')

        endpoint_data = get_endpoint_id(mac_address)
        endpoint_id = endpoint_data.get('SearchResult', {}).get('resources', [])[0].get('id', None)

        entry_context = {
            'Endpoint(val.ID === obj.ID)': {
                'ID': endpoint_id,
                'MACAddress': mac_address
            }
        }

        return_outputs(f'The endpoint ID is: {endpoint_id}', entry_context, endpoint_id)


    def get_endpoint_details(endpoint_id):
        """
        Gets endpoint details by specific id
        """

        api_endpoint = f'/ers/config/endpoint/{endpoint_id}'
        response = http_request('GET', api_endpoint)
        if response:
            return response
        else:
            return_error('Endpoint was not found.')


    def get_endpoint_details_command():
        """
        corresponds to 'cisco-ise-get-endpoint-details' command. Returns information about a specific endpoint
        """

        endpoint_id = demisto.args().get('endpointID')
        endpoint_mac_address = demisto.args().get('macAddress')

        if endpoint_mac_address and not is_mac_address(endpoint_mac_address):
            return_error('Given MAC address is invalid')

        if not endpoint_id and not endpoint_mac_address:
            return_error('Either endpoint ID or MAC address should be provided')

        if endpoint_mac_address and not endpoint_id:
            endpoint_id = get_endpoint_id(endpoint_mac_address).get('SearchResult', {}).get('resources', [])[0].get('id',
                                                                                                                    None)

        endpoint_data = get_endpoint_details(endpoint_id)

        endpoint_details = endpoint_data.get('ERSEndPoint')

        if endpoint_details:
            custom_attributes = endpoint_details.get('customAttributes')
            if custom_attributes:
                custom_attributes = custom_attributes.get('customAttributes')
            portal_user = endpoint_details.get('portalUser')
            description = endpoint_details.get('description')
            group_name = translate_group_id(endpoint_details['groupId'])
            hr = {
                'ID': endpoint_details['id'],
                'MACAddress': endpoint_details['mac'],
                'Group': group_name,
                'CustomAttributes': custom_attributes,
                'StaticGroupAssignment': endpoint_details['staticGroupAssignment'],
                'StaticProfileAssignment': endpoint_details['staticProfileAssignment']
            }
            detailed_ec = {
                'ID': endpoint_details['id'],
                'MACAddress': endpoint_details['mac'],
                'Group': group_name,
                'StaticGroupAssignment': endpoint_details['staticGroupAssignment'],
                'StaticProfileAssignment': endpoint_details['staticProfileAssignment']
            }
            if custom_attributes:
                detailed_ec['CustomAttributes'] = {}
                for attribute in custom_attributes:
                    detailed_ec['CustomAttributes'][attribute] = custom_attributes[attribute]
            if portal_user:
                hr['User'] = portal_user
                detailed_ec['User'] = portal_user
            if description:
                hr['Description'] = description
                detailed_ec['Description'] = description
            ec = {
                'Endpoint(val.ID === obj.ID)': {
                    'ID': endpoint_details['id'],
                    'MACAddress': endpoint_details['mac']
                },
                'CiscoISE.Endpoint(val.ID === obj.ID)': detailed_ec
            }

            title = 'Endpoint details - ' + (endpoint_id or endpoint_mac_address)
            return_outputs(tableToMarkdown(title, hr, removeNull=True), ec, endpoint_details)
        else:
            demisto.results('No results found')


    def reauthenticate_endpoint(mac_address, psn_address):
        """
        Reauthenticates an endpoint
        """
        api_endpoint = "/admin/API/mnt/CoA/Reauth/{}/{}/1".format(psn_address, mac_address)
        response = http_request('GET', api_endpoint)
        return response


    def get_psn_for_mac(mac_address):
        """
        Retrieves psn for an endpoint
        """
        api_endpoint = "/admin/API/mnt/AuthStatus/MACAddress/{}/86400/0/0".format(mac_address)
        response = http_request('GET', api_endpoint)
        if response:
            return response
        else:
            return_error('Could not reauthenticate the endpoint')


    def reauthenticate_endpoint_command():
        """
        corresponds to 'cisco-ise-reauthenticate-endpoint' command. Reauthenticates an endpoint
        """
        mac_address = demisto.args().get('macAddress').upper()
        if not is_mac_address(mac_address):
            return "Please enter a valid mac address"
        mac_address = mac_address.upper()
        mac_address_psn = get_psn_for_mac(mac_address)
        if not mac_address_psn:
            return "Couldn't find psn address for mac: " + mac_address
        psn_address = json.loads(xml2json(mac_address_psn)).get('restAuthStatusOutputList', {}).get(
            'authStatusList', {}).get('authStatusElements', {})[0].get('acs_server')
        if not psn_address:
            return "Couldn't find psn address for mac: " + mac_address + " response from psn endpoint was: " + json.dumps(
                mac_address_psn)
        activation_result = reauthenticate_endpoint(mac_address, psn_address).text
        json_activation_result = json.loads(xml2json(activation_result)).get('remoteCoA').get('results')
        activation_result_boolean = 'true' in json_activation_result

        entry_context = {
            "CiscoISE.Endpoint(val.MACAddress==obj.MACAddress)": {
                'MACAddress': json_activation_result,
                'reauthenticateResult': activation_result_boolean
            }
        }

        return_outputs('Activation result was : ' + str(activation_result_boolean), entry_context, activation_result)


    def get_endpoints():
        """
        Gets data about existing endpoints
        """

        api_endpoint = "/ers/config/endpoint"
        return http_request('GET', api_endpoint)


    def get_endpoints_command(return_bool: bool = False):
        """
        corresponds to 'ise-get-endpoints' command. Get data about the existing endpoints
        """

        endpoints_data = get_endpoints().get('SearchResult', {})

        if endpoints_data.get('total', 0) < 1:
            return 'No endpoints were found.'

        endpoints = endpoints_data.get('resources', [])

        context = []
        hr = []

        for endpoint in endpoints:
            context_dict = {
                'ID': endpoint.get('id'),
                'MACAddress': endpoint.get('name')
            }
            hr_dict = dict(context_dict)
            context.append(context_dict)
            hr.append(hr_dict)
        if return_bool:
            return True
        entry_context = {
            'Endpoint(val.ID == obj.ID)': context,
            'CiscoISE.Endpoint(val.ID == obj.ID)': context
        }

        return_outputs(tableToMarkdown(
            'Cisco ISE Endpoints', hr, ['ID', 'MACAddress'], removeNull=True),
            entry_context,
            endpoints
        )


    def update_endpoint_by_id(endpoint_id, endpoint_details):
        """
        Updates endpoint status
        """
        api_endpoint = f'/ers/config/endpoint/{endpoint_id}'
        response = http_request('PUT', api_endpoint, data=json.dumps(endpoint_details))
        return response


    def update_endpoint_custom_attribute_command():
        """
        corresponds to 'cisco-ise-update-endpoint-custom-attribute' command.
        Blocks endpoint using predefined custom fields
        """

        endpoint_id = demisto.args().get('id')
        endpoint_mac_address = demisto.args().get('macAddress')

        if endpoint_mac_address and not is_mac_address(endpoint_mac_address):
            return_error('Please enter a valid mac address')

        if not endpoint_id and not endpoint_mac_address:
            return_error('Please enter either endpoint id or endpoint mac address')

        if endpoint_mac_address and not endpoint_id:
            endpoint_id = get_endpoint_id(endpoint_mac_address).get('SearchResult', {}).get('resources', [])[0].get('id',
                                                                                                                    None)

        endpoint_details = get_endpoint_details(endpoint_id)

        if "ERSEndPoint" not in endpoint_details:
            return_error('Failed to get endpoint %s' % endpoint_id)

        attribute_names = demisto.args().get('attributeName').split(',')
        attribute_values = demisto.args().get('attributeValue').split(',')

        attributes_dic = {}
        for couple in zip(attribute_names, attribute_values):
            attributes_dic[couple[0]] = couple[1]
        try:
            demisto.info("Updating endpoint %s" % endpoint_mac_address)
            del endpoint_details['ERSEndPoint']['link']
            if endpoint_details['ERSEndPoint'].get('customAttributes'):
                endpoint_details['ERSEndPoint']['customAttributes']['customAttributes'] = attributes_dic
            else:
                endpoint_details['ERSEndPoint']['customAttributes'] = {'customAttributes': attributes_dic}

            update_result = update_endpoint_by_id(endpoint_id, endpoint_details)
            if not update_result:
                # result = update_result.get('ERSResponse', {}).get('messages', [])
                demisto.results("Update failed for endpoint " + endpoint_id + ". Please check if the custom "
                                                                              "fields are defined in the system. "
                                                                              "Got the following response: "
                                + update_result.get('ERSResponse', {}).get('messages', []))

            updated_fields_dict_list = update_result.get('UpdatedFieldsList', {}).get('updatedField', [])

            if len(updated_fields_dict_list) > 0:
                updated_fields_string = ' the new custom fields are: ' + json.dumps(
                    updated_fields_dict_list[0].get('newValue'))
            else:
                updated_fields_string = ", but the fields that you've tried to update already had that specific value " \
                                        "or do not exist"
            demisto.info('Successfully updated endpoint %s with fields - %s' % (endpoint_mac_address, updated_fields_string))
            demisto.results('Successfully updated endpoint %s' % endpoint_id + updated_fields_string)

        except Exception as e:
            raise Exception("Exception: Failed to update endpoint {}: ".format(endpoint_id) + str(e))


    def update_endpoint_group_command():
        """
        corresponds to 'cisco-ise-update-endpoint-group' command. Updates endpoint status
        """

        endpoint_group_name = demisto.args().get('groupName')
        endpoint_group_id = demisto.args().get('groupId')
        if not endpoint_group_name and not endpoint_group_id:
            return_error('Please enter either group id or group name')

        if endpoint_group_name and not endpoint_group_id:
            endpoint_group_data = get_endpoint_id(endpoint_group_name).get('SearchResult', {})
            if endpoint_group_data.get('total', 0) < 1:
                demisto.results('No endpoints were found. Please make sure you entered the correct group name')

            endpoint_group_id = endpoint_group_data.get('resources')[0].get('id')

        endpoint_id = demisto.args().get('id')
        endpoint_mac_address = demisto.args().get('macAddress')

        if endpoint_mac_address and not is_mac_address(endpoint_mac_address):
            return_error('Please enter a valid mac address')

        if not endpoint_id and not endpoint_mac_address:
            return_error('Please enter either endpoint id or endpoint mac address')

        if endpoint_mac_address and not endpoint_id:
            endpoint_id = get_endpoint_id(endpoint_mac_address).get('SearchResult', {}).get('resources', [])[0].get('id',
                                                                                                                    None)
        endpoint_details = get_endpoint_details(endpoint_id)

        if "ERSEndPoint" not in endpoint_details:
            return_error('Failed to get endpoint %s' % endpoint_id)

        try:
            endpoint_details['ERSEndPoint']['groupId'] = endpoint_group_id
            update_result = update_endpoint_by_id(endpoint_id, endpoint_details)
            if update_result:
                # Create result
                msg = "Endpoint " + endpoint_id + " updated successfully"
            else:
                "Update failed for endpoint " + endpoint_id + ", got the following response: " + update_result.get(
                    'ERSResponse', {}).get('messages', [])

        except Exception as e:
            raise Exception("Exception: Failed to update endpoint {}: ".format(endpoint_id) + str(e))

        demisto.results(msg)


    def list_number_of_active_sessions():
        """
        This function is used for test-module to check connectivity
        """
        api_endpoint = "/admin/API/mnt/Session/ActiveCount"

        response = http_request('GET', api_endpoint)

        return response


    def get_policies_request():

        api_endpoint = '/ers/config/ancpolicy'

        response = http_request('GET', api_endpoint)

        return response


    def get_policies():
        """
        Return all ANC policies
        """
        data = []

        policies_data = get_policies_request().get('SearchResult', {})

        if policies_data.get('total', 0) < 1:
            return 'No policies were found.'

        policies = policies_data.get('resources', [])

        for policy in policies:
            data.append({
                'ID': policy.get('id'),
                'Name': policy.get('name')
            })

        context = {
            'CiscoISE.Policy(val.ID && val.ID === obj.ID)': data
        }

        return_outputs(
            tableToMarkdown('CiscoISE Adaptive Network Control Policies', data, removeNull=True),
            context,
            policies_data
        )


    def get_policy_by_name(policy_name):

        api_endpoint = f'/ers/config/ancpolicy/name/{policy_name}'

        response = http_request('GET', api_endpoint)
        return response


    def get_policy():
        """
        Returns: the specific ANC policy
        """

        data = []
        policy_name = demisto.args().get('policy_name')

        if not policy_name:
            return_error('Please enter either policy name or policy id')

        if policy_name:
            policy_data = get_policy_by_name(policy_name).get('ErsAncPolicy', {})

        if policy_data:
            data.append({
                'Name': policy_data.get('name'),
                'Action': policy_data.get('actions')
            })

        context = {
            'CiscoISE.Policy(val.ID && val.ID === obj.ID)': data
        }

        return_outputs(tableToMarkdown('CiscoISE Policy', data, removeNull=True), context, policy_data)


    def create_policy_request(data):

        api_endpoint = '/ers/config/ancpolicy'

        http_request('POST', api_endpoint, data=json.dumps(data))


    def create_policy():
        """
        Create ANC Policy
        """
        policy_name = demisto.args().get('policy_name')
        policy_actions = demisto.args().get('policy_actions', '')

        data = {
            'ErsAncPolicy': {
                'name': policy_name,
                'actions': [policy_actions]
            }
        }
        create_policy_request(data)
        policy_context = {
            'Name': policy_name,
            'Action': [policy_actions]
        }

        context = {
            'CiscoISE.Policy(val.Name && val.Name === obj.Name)': policy_context
        }

        return_outputs(f'The policy "{policy_name}" has been created successfully', context)


    def assign_policy_request(data):

        api_endpoint = '/ers/config/ancendpoint/apply'

        http_request('PUT', api_endpoint, data=json.dumps(data))


    def assign_policy_to_endpoint():
        """
        Apply ANC policy to an endpoint
        """

        policy_name = demisto.args().get('policy_name')
        mac_address = demisto.args().get('mac_address')
        if not is_mac_address(mac_address):
            return_error('Please enter a valid mac address')

        data = {
            'OperationAdditionalData': {
                'additionalData': [{
                    'name': 'macAddress',
                    'value': mac_address
                },
                    {
                    'name': 'policyName',
                    'value': policy_name
                }
                ]
            }
        }
        assign_policy_request(data)

        endpoint_context = {
            'MACAddress': mac_address,
            'PolicyName': policy_name
        }

        context = {
            'CiscoISE.Endpoint(val.ID && val.ID === obj.ID)': endpoint_context
        }

        return_outputs(f'The policy "{policy_name}" has been assigned successfully', context)


    def remove_policy_request(data):

        api_endpoint = '/ers/config/ancendpoint/clear'

        http_request('PUT', api_endpoint, data=json.dumps(data))


    def remove_policy_from_endpoint():
        """
        Remove ANC policy from an endpoint
        """

        policy_name = demisto.args().get('policy_name')
        mac_address = demisto.args().get('mac_address')
        if not is_mac_address(mac_address):
            return_error('Please enter a valid mac address')

        data = {
            'OperationAdditionalData': {
                'additionalData': [{
                    'name': 'macAddress',
                    'value': mac_address
                },
                    {
                    'name': 'policyName',
                    'value': policy_name
                }
                ]
            }
        }
        remove_policy_request(data)

        endpoint_context = {
            'MACAddress': mac_address,
            'PolicyName': policy_name
        }

        context = {
            'CiscoISE.Endpoint(val.ID && val.ID === obj.ID)': endpoint_context
        }

        return_outputs(f'The policy "{policy_name}" has been removed successfully', context)


    def get_blacklist_group_id():

        api_endpoint = '/ers/config/endpointgroup?filter=name.EQ.Blacklist'

        response = http_request('GET', api_endpoint)

        return response


    def get_blacklist_endpoints_request():

        blacklist = get_blacklist_group_id().get('SearchResult', {})
        blacklist_id = blacklist.get('resources', [])[0]
        black_id = blacklist_id.get('id')

        api_endpoint = f'/ers/config/endpoint?filter=groupId.EQ.{black_id}'
        blacklist_response = http_request('GET', api_endpoint)

        return blacklist_response


    def get_blacklist_endpoints():

        data = []
        blacklist_endpoints = get_blacklist_endpoints_request().get('SearchResult', {})

        if blacklist_endpoints.get('total', 0) < 1:
            demisto.results('No endpoints were found.')

        endpoints = blacklist_endpoints.get('resources', [])

        for endpoint in endpoints:
            data.append({
                'ID': endpoint.get('id'),
                'Name': endpoint.get('name'),
                'GroupName': 'Blacklist'
            })

        context = {
            'CiscoISE.Endpoint(val.ID && val.ID === obj.ID)': data
        }

        return_outputs(tableToMarkdown('CiscoISE Blacklist Endpoints', data, removeNull=True), context, endpoints)


    def get_endpoint_id_by_name(mac_address=None):
        """
        Returns endpoint id by specific mac address
        Only compatible with Cisco ISE versions 2.3
        """
        if not is_mac_address(mac_address):
            return_error('Given MAC address is invalid')

        api_endpoint = f'/ers/config/endpoint/name/{mac_address}'
        return http_request('GET', api_endpoint, '')


    def get_endpoint_id_by_name_command():

        mac_address = demisto.args().get('mac_address')

        if not is_mac_address(mac_address):
            return_error('Given MAC address is invalid')

        endpoint_data = get_endpoint_id_by_name(mac_address)
        endpoint_id = endpoint_data.get('ERSEndPoint', {}).get('id', None)

        entry_context = {
            'Endpoint(val.ID === obj.ID)': {
                'ID': endpoint_id,
                'MACAddress': mac_address
            }
        }

        return_outputs(f'The endpoint ID is: {endpoint_id}', entry_context, endpoint_id)


    def get_node_details(name=None):
        """
        Returns details for the given Cisco ISE node
        """
        if not name:
            return_error('Given Cisco ISE node is invalid')

        api_endpoint = f'/ers/config/node/name/{name}'
        return http_request('GET', api_endpoint, '')


    def get_all_nodes_command():
        """
        Returns all nodes in the Cisco ISE Deployment
        Also sets isLocalIstance in the output
        """

        instance_ip = urlparse(BASE_URL).netloc
        try:
            instance_ip = socket.gethostbyname(instance_ip)
        except Exception as e:
            err_msg = (f'Failed to get ip address of configured Cisco ISE instance - {e}')
            raise Exception(err_msg)

        data = []
        api_endpoint = '/ers/config/node'
        response = http_request('GET', api_endpoint)
        results = response.get('SearchResult', {})

        if results.get('total', 0) < 1:
            demisto.results("No Nodes were found")

        node_data = results.get('resources', [])
        for node in node_data:
            is_local_istance = False
            name = node.get('name')
            node_details = get_node_details(name).get('Node', {})
            ip = node_details.get('ipAddress')
            if ip == instance_ip:
                is_local_istance = True

            data.append({
                'Name': name,
                'ip': ip,
                'isLocalIstance': is_local_istance,
                # if false then standalone mode.. ie single node
                'inDeployment': node_details.get('inDeployment'),
                # primary means active node
                'primaryPapNode': node_details.get('primaryPapNode'),
            })

        context = {
            'CiscoISE.NodesData': data
        }

        return_outputs(tableToMarkdown('CiscoISE deployment nodes', data, removeNull=True), context)


    def create_new_endpoint_command():
        """
        Creates a new Endpoint in Cisco ISE with the given
        Mac address and Custom attributes
        """

        attr_map = demisto.args().get('attributes_map')
        mac_address = demisto.args().get('mac_address')
        if not is_mac_address(mac_address):
            return_error('Please enter a valid mac address')
        if attr_map is not None:
            attr_map = json.loads(attr_map)
        data = {
            "ERSEndPoint": {
                "mac": mac_address,
                "customAttributes": {
                    "customAttributes": attr_map
                }
            }
        }

        demisto.info("Creating new endpoint on Cisco ISE. mac - %s, attributes - %s" % (mac_address, attr_map))
        api_endpoint = '/ers/config/endpoint'
        http_request('POST', api_endpoint, data=json.dumps(data))
        endpoint_context = {
            'MACAddress': mac_address,
        }

        context = {
            'CiscoISE.Endpoint(val.Name && val.Name === obj.Name)': endpoint_context
        }
        demisto.info("Endpoing %s has been created successfully" % mac_address)
        return_outputs(f'Endpoint "{mac_address}" has been created successfully', context)


    def get_session_data_by_ip_request(ip):
        ip_address = f'/admin/API/mnt/Session/EndPointIPAddress/{ip}'
        response = http_request('GET', ip_address, is_admin_api=True)
        byte_conversion = str(response, 'utf-8')
        json_data = xml2json(byte_conversion)
        session_data = json.loads(json_data)

        context = {
            'CiscoISE.Endpoint(val.ID && val.ID === obj.ID)': session_data
        }

        return_outputs('The targeted users session xml is being returned.', context)


    def get_session_data_by_ip():
        """
        Returns: the session data given an ip address
        """
        ip = demisto.args().get('ip_address')
        if not ip:
            return_error('Please enter the ip')

        get_session_data_by_ip_request(ip)

    def get_acl_id(url,name):
        page = 1
        size=20
        total_size=size
        while True:
            page_url=url+'?size='+str(size)+'&page='+str(page)
            page += 1
            response = http_request('GET', page_url)
            if not response['SearchResult']['resources']:
                return None
            for obj in response['SearchResult']['resources']:
                if obj['name'] == name:
                    return obj['id']
            if response['SearchResult']['total'] <= total_size:
                return None
            else:
                total_size += 20
        return None

    def get_auth_profile_by_name(url, name):
        page_url = url + '/name/'+name
        response = http_request('GET', page_url)
        try:
            if response.status_code == 404:
                return None
        except:
            return response['AuthorizationProfile']['id']
        return None

    def get_auth_profile_id_by_name_command():
        auth_profile_name = demisto.args().get('name')
        auth_profile_api_url = '/ers/config/authorizationprofile'
        auth_profile_id = get_auth_profile_by_name(auth_profile_api_url, auth_profile_name)
        if auth_profile_id is None:
            auth_profile_id='None'
        entry_context = {
            'CiscoISE.AuthProfile(val.ID === obj.ID)': {
                'ID': auth_profile_id
            }
        }
        return_outputs(f'The auth profile ID is: {auth_profile_id}', entry_context, auth_profile_id)

    def get_dacl_id_by_name_command():
        """
        Returns dacl id by using dacl name
        """
        dacl_name = demisto.args().get('name')
        dacl_api_url = '/ers/config/downloadableacl'
        dacl_id = get_acl_id(dacl_api_url, dacl_name)
        if dacl_id is None:
            dacl_id='None'
        entry_context = {
            'CiscoISE.Dacl(val.ID === obj.ID)': {
                'ID': dacl_id
            }
        }
        return_outputs(f'The dacl ID is: {dacl_id}', entry_context, dacl_id)

    def get_sgacl_id_by_name_command():
        """
        Returns sgacl id by using sgacl name
        """
        sgacl_name = demisto.args().get('name')
        sgacl_api_url = '/ers/config/sgacl'
        sgacl_id = get_acl_id(sgacl_api_url, sgacl_name)
        if sgacl_id is None:
            sgacl_id='None'
        entry_context = {
            'CiscoISE.Sgacl(val.ID === obj.ID)': {
                'ID': sgacl_id
            }
        }
        return_outputs(f'The sgacl ID is: {sgacl_id}', entry_context, sgacl_id)

    def get_sgt_id_command():
        sgt_name = demisto.args().get('name')
        sgt_api_url = '/ers/config/sgt'
        sgt_id = get_acl_id(sgt_api_url, sgt_name)
        if sgt_id is None:
            sgt_id='None'
        entry_context = {
            'CiscoISE.Sgt(val.ID === obj.ID)': {
                'ID': sgt_id
            }
        }
        return_outputs(f'The sgt ID is: {sgt_id}', entry_context, sgt_id)

    def create_sgt_command():
        sgt_name = demisto.args().get('name')
        sgt_description = demisto.args().get('description')
        if sgt_description is None:
            sgt_description = sgt_name
        response = create_sgt(sgt_name,sgt_description)
        if response is None:
            entry_context = {
                'CiscoISE.Create(val.ID === obj.ID)': {
                    'SgtName': sgt_name
                }
            }
            return_outputs(f'Created sgt:{sgt_name}', entry_context, sgt_name)
        else:
            return_error(f'Error while creating sgt :{sgt_name}')

    def create_sgt(sgt_name,sgt_description):
        sgt_api_url = '/ers/config/sgt'
        data = json.dumps({
            "Sgt": {
                "name": sgt_name,
                "description": sgt_description,
                "value" : -1,
                "propogateToApic" : False
            }
        })
        # return_outputs('creating sgacl with content:'+str(data))
        response = http_request('POST', url_suffix=sgt_api_url, data=data)
        return response

    def create_sgacl_command():
        sgacl_name = demisto.args().get('name')
        sgacl_description = demisto.args().get('description')
        if sgacl_description is None:
            sgacl_description = sgacl_name
        sgacl_content = demisto.args().get('content')
        response = create_sgacl(sgacl_name,sgacl_description,sgacl_content)
        if response is None:
            entry_context = {
                'CiscoISE.Create(val.ID === obj.ID)': {
                    'DaclName': sgacl_name
                }
            }
            return_outputs(f'Created sgacl:{sgacl_name} with content: {sgacl_content}', entry_context, sgacl_name)
        else:
            return_error(f'Error while creating sgacl :{sgacl_name}')

    def create_sgacl(sgacl_name,sgacl_description,sgacl_content):
        sgacl_api_url = '/ers/config/sgacl'
        content = '\n'.join(sgacl_content)

        data = json.dumps({
            "Sgacl": {
                "name": sgacl_name,
                "description": sgacl_description,
                "ipVersion": "IPV4",
                "aclcontent": content
            }
        })
        # return_outputs('creating sgacl with content:'+str(data))
        response = http_request('POST', url_suffix=sgacl_api_url, data=data)
        return response

    def update_sgacl_command():
        sgacl_id = demisto.args().get('id')
        sgacl_name = demisto.args().get('name')
        sgacl_description = demisto.args().get('description')
        if sgacl_description is None:
            sgacl_description = sgacl_name
        sgacl_content = demisto.args().get('content')
        response = update_sgacl(sgacl_id,sgacl_name,sgacl_description,sgacl_content)
        entry_context = {
            'CiscoISE.Update(val.ID === obj.ID)': {
                'SgaclName': sgacl_name,
                'SgaclID': sgacl_id
            }
        }
        return_outputs(f'Updated sgacl:{sgacl_name} with content: {sgacl_content}', entry_context, sgacl_name)


    def update_sgacl(sgacl_id,sgacl_name,sgacl_description,sgacl_content):
        content = '\n'.join(sgacl_content)
        sgacl_api_url = '/ers/config/sgacl/' + sgacl_id
        data = json.dumps({
            "Sgacl": {
                "id": sgacl_id,
                "name": sgacl_name,
                "description": sgacl_description,
                "ipVersion": "IPV4",
                "aclcontent": content
            }
        })
        response = http_request('PUT', url_suffix=sgacl_api_url, data=data)
        return response

    def create_dacl_command():
        dacl_name = demisto.args().get('name')
        dacl_description = demisto.args().get('description')
        if dacl_description is None:
            dacl_description = dacl_name
        dacl_content = demisto.args().get('content')
        # return_outputs('dacl_content type'+str(type(dacl_content))+' and content is: '+str(dacl_content))
        response = create_dacl(dacl_name,dacl_description,dacl_content)
        if response is None:
            entry_context = {
                'CiscoISE.Create(val.ID === obj.ID)': {
                    'DaclName': dacl_name
                }
            }
            return_outputs(f'Created dacl:{dacl_name} with content: {dacl_content}', entry_context, dacl_name)
        else:
            return_error(f'Error while creating dacl :{dacl_name}')

    def create_dacl(dacl_name,dacl_description,dacl_content):
        dacl_api_url = '/ers/config/downloadableacl'
        content = '\n'.join(dacl_content)

        data = json.dumps({
            "DownloadableAcl": {
                "name": dacl_name,
                "description": dacl_description,
                "dacl": content
            }
        })
        # return_outputs('creating:'+str(data))
        response = http_request('POST', url_suffix=dacl_api_url, data=data)
        return response

    def update_dacl_command():
        dacl_id = demisto.args().get('id')
        dacl_name = demisto.args().get('name')
        dacl_description = demisto.args().get('description')
        if dacl_description is None:
            dacl_description = dacl_name
        dacl_content = demisto.args().get('content')
        response = update_dacl(dacl_id,dacl_name,dacl_description,dacl_content)
        entry_context = {
            'CiscoISE.Update(val.ID === obj.ID)': {
                'DaclName': dacl_name,
                'DaclID': dacl_id
            }
        }
        return_outputs(f'Updated dacl:{dacl_name} with content: {dacl_content}', entry_context, dacl_name)


    def update_dacl(dacl_id,dacl_name,dacl_description,dacl_content):
        content = '\n'.join(dacl_content)
        dacl_api_url = '/ers/config/downloadableacl/' + dacl_id
        data = json.dumps({
            "DownloadableAcl": {
                "id": dacl_id,
                "name": dacl_name,
                "description": dacl_description,
                "dacl": content
            }
        })
        response = http_request('PUT', url_suffix=dacl_api_url, data=data)
        return response

    def create_auth_profile_command():
        auth_profile_name = demisto.args().get('name')
        auth_profile_content = demisto.args().get('content')
        content=None
        if(type(auth_profile_content) == str):
            content = json.loads(auth_profile_content)
        else:
            content = auth_profile_content
        default_content = {
            "AuthorizationProfile": {
                "name": auth_profile_name
            }
        }
        for key, value in content.items():
            default_content['AuthorizationProfile'][key]=value
        auth_profile_api_url = '/ers/config/authorizationprofile'
        response = http_request('POST', url_suffix=auth_profile_api_url, data=json.dumps(default_content))
        entry_context = {
            'CiscoISE.Create(val.ID === obj.ID)': {
                'AuthName': auth_profile_name
            }
        }
        return_outputs(f'Created authentication profile:{auth_profile_name} with content:{default_content}', entry_context, auth_profile_name)


    def update_auth_profile_command():
        auth_profile_id = demisto.args().get('id')
        auth_profile_name = demisto.args().get('name')
        auth_profile_content = demisto.args().get('content')
        content=None
        if(type(auth_profile_content) == str):
            content = json.loads(auth_profile_content)
        else:
            content = auth_profile_content
        default_content = {
            "AuthorizationProfile": {
                "id": auth_profile_id,
                "name": auth_profile_name
            }
        }
        for key, value in content.items():
            default_content['AuthorizationProfile'][key]=value
        auth_profile_api_url = '/ers/config/authorizationprofile/'+auth_profile_id
        data = default_content
        response = http_request('PUT', url_suffix=auth_profile_api_url, data=json.dumps(data))
        entry_context = {
            'CiscoISE.Update(val.ID === obj.ID)': {
                'AuthName': auth_profile_name
            }
        }
        return_outputs(f'Updated authentication profile:{auth_profile_name} with content : {default_content}', entry_context, auth_profile_name)

    def create_egress_matrix_command():
        egress_matrix_src_sgt_id = demisto.args().get('srcSgtID')
        egress_matrix_dest_sgt_id = demisto.args().get('destSgtID')
        egress_matrix_sgacl_ids = demisto.args().get('sgaclIDs')
        response = create_egress_matrix(egress_matrix_src_sgt_id, egress_matrix_dest_sgt_id, egress_matrix_sgacl_ids)
        status = 'CREATED'
        entry_context = {
            'CiscoISE.Create(val.ID === obj.ID)': {
                'EgressMatrixStatus': status
            }
        }
        return_outputs(f'Created the egress matrix with {egress_matrix_src_sgt_id}, {egress_matrix_dest_sgt_id}, {egress_matrix_sgacl_ids} and the status is:{status}', entry_context, 'CREATED')

    def create_egress_matrix(src_sgt_id, dest_sgt_id, sgacl_ids):
        egress_matrix_api_url = '/ers/config/egressmatrixcell'
        data = json.dumps({
            "EgressMatrixCell" : {
                "sourceSgtId" : src_sgt_id,
                "destinationSgtId" : dest_sgt_id,
                "matrixCellStatus" : "MONITOR",
                "defaultRule" : "PERMIT_IP",
                "sgacls" : sgacl_ids
            }
        })
        response = http_request('POST', url_suffix=egress_matrix_api_url, data=data)
        return response

    def update_egress_matrix_command():
        egress_matrix_id = demisto.args().get('id')
        egress_matrix_src_sgt_id = demisto.args().get('srcSgtID')
        egress_matrix_dest_sgt_id = demisto.args().get('destSgtID')
        egress_matrix_sgacl_ids = demisto.args().get('sgaclIDs')
        egress_matrix_default_rule = demisto.args().get('defaultRule')
        egress_matrix_cell_status = demisto.args().get('matrixCellStatus')
        response = update_egress_matrix(egress_matrix_id,egress_matrix_src_sgt_id,egress_matrix_dest_sgt_id,egress_matrix_sgacl_ids,egress_matrix_default_rule,egress_matrix_cell_status)
        entry_context = {
            'CiscoISE.Update(val.ID === obj.ID)': {
                'EgressMatrixID': egress_matrix_id
            }
        }
        return_outputs(f'Updated the egress matrix with {egress_matrix_src_sgt_id}, {egress_matrix_dest_sgt_id}, {egress_matrix_sgacl_ids} and the status is:{status}', entry_context, egress_matrix_id)


    def update_egress_matrix(matrix_id, src_sgt_id, dest_sgt_id, sgacl_ids, egress_matrix_default_rule, egress_matrix_cell_status):
        egress_matrix_api_url = '/ers/config/egressmatrixcell/'+matrix_id
        data = json.dumps({
            "EgressMatrixCell" : {
                "sourceSgtId" : src_sgt_id,
                "destinationSgtId" : dest_sgt_id,
                "matrixCellStatus" : egress_matrix_cell_status,
                "defaultRule" : egress_matrix_default_rule,
                "sgacls" : sgacl_ids
            }
        })
        response = http_request('PUT', url_suffix=egress_matrix_api_url, data=data)
        return response

    def get_egress_matrix_id_command():
        sourceSgt = demisto.args().get('sourceSgt')
        destSgt = demisto.args().get('destSgt')
        response = get_egress_matrix_id(sourceSgt,destSgt)
        results = response['SearchResult']['resources']
        ids=[]
        if len(results) > 0:
            for eachObj in results:
                ids.append(eachObj['id'])
        entry_context = {
            'CiscoISE.Matrix(val.ID === obj.ID)': {
                'ID': ids
            }
        }
        return_outputs(f'Updated the egress matrix with {ids}', entry_context, ids)

    def get_egress_matrix_id(sourceSgt, destSgt):
        egress_matrix_api_url = '/ers/config/egressmatrixcell'
        params={'filter':['sgtSrcName.CONTAINS.'+sourceSgt,'sgtDstName.CONTAINS.'+destSgt]}
        response = http_request('GET',params=params,url_suffix=egress_matrix_api_url)
        return response

    def get_egress_matrix_command():
        matrix_id = demisto.args().get('id')
        response = get_egress_matrix(matrix_id)
        result={}
        egress_matrix_cell = response['EgressMatrixCell']
        matrixCellStatus=egress_matrix_cell['matrixCellStatus']
        defaultRule=egress_matrix_cell['defaultRule']
        sgacls=egress_matrix_cell['sgacls']
        result['matrixCellStatus']=matrixCellStatus
        result['defaultRule']=defaultRule
        result['sgacls']=sgacls
        entry_context = {
            'CiscoISE.Matrix(val.ID === obj.ID)': {
                'MatrixCellStatus':matrixCellStatus,
                'DefaultRule':defaultRule,
                'Sgacls':sgacls
            }
        }
        return_outputs(f'Updated the egress matrix with {result}', entry_context, result)

    def get_egress_matrix(matrix_id):
        egress_matrix_api_url = '/ers/config/egressmatrixcell/'+matrix_id
        response = http_request('GET',url_suffix=egress_matrix_api_url)
        return response


    def get_mnt_mac_session_command():
        mac_address = demisto.args().get('mac_address')
        if not MNT_URL:
            return_error("Monitor node not configured")
        if not mac_address:
            return_error('Please enter the mac_address')
        if not is_mac_address(mac_address):
            return_error('Given MAC address is invalid')
        mnt_mac_url = '/admin/API/mnt/Session/MACAddress/{0}'.format(mac_address.upper())
        response = http_request('GET', url_suffix=mnt_mac_url, is_mnt_api=True)
        return_results(response)


    def get_mnt_version(return_bool: bool = False):
        mnt_version_url = '/admin/API/mnt/Version'
        if not MNT_URL:
            return_error("Monitor node not configured")
        response = http_request('GET', url_suffix=mnt_version_url, is_mnt_api=True)
        if return_bool:
            return True
        return response

    def test_connection():
        ERS_CONN = get_endpoints_command(True)
        if MNT_URL:
            SESSION_CONN = get_mnt_version(True)
            if not SESSION_CONN and not ERS_CONN:
                demisto.results ('ERS and Session/MNT test failed.')
            elif not SESSION_CONN:
                demisto.results ('Session/MNT test failed.')
            elif not ERS_CONN:
                demisto.results ('ERS test failed.')
            else:
                demisto.results ('ok')
        if ERS_CONN:
            demisto.results('ok')
        else:
            demisto.results('ERS test failed')

    def get_ers_profile_by_id_command():
        profile_id = demisto.args().get('profile_id')
        if not profile_id:
            return_error("Profile can not be None")
        get_profile_by_id_url = '/ers/config/profilerprofile/%s' % profile_id
        response = http_request('GET', url_suffix=get_profile_by_id_url)
        return_results(response)

    ''' EXECUTION CODE '''
    def main():

        LOG('Command being called is %s' % (demisto.command()))
        try:
            handle_proxy()
            if demisto.command() == 'test-module':
                test_connection()
            elif demisto.command() == 'cisco-ise-get-endpoint-id':
                get_endpoint_id_command()
            elif demisto.command() == 'cisco-ise-get-endpoint-details':
                get_endpoint_details_command()
            elif demisto.command() == 'cisco-ise-reauthenticate-endpoint':
                reauthenticate_endpoint_command()
            elif demisto.command() == 'cisco-ise-get-endpoints':
                get_endpoints_command()
            elif demisto.command() == 'cisco-ise-update-endpoint-custom-attribute':
                update_endpoint_custom_attribute_command()
            elif demisto.command() == 'cisco-ise-update-endpoint-group':
                update_endpoint_group_command()
            elif demisto.command() == 'cisco-ise-get-groups':
                get_groups()
            elif demisto.command() == 'cisco-ise-get-policies':
                get_policies()
            elif demisto.command() == 'cisco-ise-get-policy':
                get_policy()
            elif demisto.command() == 'cisco-ise-create-policy':
                create_policy()
            elif demisto.command() == 'cisco-ise-assign-policy':
                assign_policy_to_endpoint()
            elif demisto.command() == 'cisco-ise-remove-policy':
                remove_policy_from_endpoint()
            elif demisto.command() == 'cisco-ise-get-blacklist-endpoints':
                get_blacklist_endpoints()
            elif demisto.command() == 'cisco-ise-create-endpoint':
                create_new_endpoint_command()
            elif demisto.command() == 'cisco-ise-get-nodes':
                get_all_nodes_command()
            elif demisto.command() == 'cisco-ise-get-endpoint-id-by-name':
                get_endpoint_id_by_name_command()
            elif demisto.command() == 'cisco-ise-get-session-data-by-ip':
                get_session_data_by_ip()
            elif demisto.command() == 'cisco-ise-get-dacl-id':
                get_dacl_id_by_name_command()
            elif demisto.command() == 'cisco-ise-get-sgacl-id':
                get_sgacl_id_by_name_command()
            elif demisto.command() == 'cisco-ise-get-authorization-profile-id':
                get_auth_profile_id_by_name_command()
            elif demisto.command() == 'cisco-ise-create-dacl':
                create_dacl_command()
            elif demisto.command() == 'cisco-ise-update-dacl':
                update_dacl_command()
            elif demisto.command() == 'cisco-ise-create-auth-profile':
                create_auth_profile_command()
            elif demisto.command() == 'cisco-ise-update-auth-profile':
                update_auth_profile_command()
            elif demisto.command() == 'cisco-ise-create-sgacl':
                create_sgacl_command()
            elif demisto.command() == 'cisco-ise-update-sgacl':
                update_sgacl_command()
            elif demisto.command() == 'cisco-ise-get-sgt-id':
                get_sgt_id_command()
            elif demisto.command() == 'cisco-ise-create-sgt':
                create_sgt_command()
            elif demisto.command() == 'cisco-ise-get-egress-matrix-id':
                get_egress_matrix_id_command()
            elif demisto.command() == 'cisco-ise-get-egress-matrix':
                get_egress_matrix_command()
            elif demisto.command() == 'cisco-ise-create-egress-matrix':
                create_egress_matrix_command()
            elif demisto.command() == 'cisco-ise-update-egress-matrix':
                update_egress_matrix_command()
            elif demisto.command() == 'cisco-ise-mnt-get-session-by-mac':
                get_mnt_mac_session_command()
            elif demisto.command() == 'cisco-ise-get-ers-profile-by-id':
                get_ers_profile_by_id_command()

        except Exception as e:
            return_error(str(e))


    # python2 uses __builtin__ python3 uses builtins
    if __name__ == "__builtin__" or __name__ == "builtins":
        main()


    register_module_line('PANW IoT 3rd Party Integration - Cisco ISE', 'end', __line__())
  subtype: python3
  type: python
sourcemoduleid: Cisco ISE
