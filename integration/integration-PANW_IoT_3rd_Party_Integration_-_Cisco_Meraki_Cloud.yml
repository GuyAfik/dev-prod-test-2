category: IT Services
commonfields:
  id: PANW IoT 3rd Party Integration - Cisco Meraki Cloud
  version: -1
configuration:
- display: Server URL (e.g., https://api.meraki.com)
  name: url
  required: false
  type: 0
- display: API Key
  name: apiKey
  required: true
  type: 4
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    packName: ""
    prevname: ""
    propagationLabels:
    - all
    toServerVersion: ""
description: Cloud controlled WiFi and Wired Network Clients are retrieved.
detaileddescription: |-
  1. In the Meraki Dashboard, select Organization > Settings.
  2. In the Dashboard API access section of the Settings page, do the following: Select Enable access to the Cisco Meraki Dashboard API.
  3. Go to profile page and in the API access section, select Generate API Key. The generated API Key is displayed.
display: PANW IoT 3rd Party Integration - Cisco Meraki Cloud
image: data:image/png;base64,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
name: PANW IoT 3rd Party Integration - Cisco Meraki Cloud
script:
  commands:
  - arguments: []
    description: Get Cisco Meraki Cloud managed access points and controllers organizations.
    name: panw-iot-3rd-party-cisco-meraki-get-organizations
    outputs:
    - contextPath: cisco_meraki.organizations
  - arguments:
    - description: Organization ID
      name: organizationID
      required: true
    description: Get Cisco Meraki Cloud managed Organizations networks.
    name: panw-iot-3rd-party-cisco-meraki-get-networks
    outputs:
    - contextPath: cisco_meraki.networks
  - arguments:
    - description: Network ID
      name: networkID
      required: true
    - description: The beginning of the timespan for the data. The maximum lookback
        period is 31 days from today.
      name: t0
    - description: The timespan for which the information will be fetched. If specifying
        timespan, do not specify parameter t0. The value must be in seconds and be
        less than or equal to 31 days. The default is 1 day.
      name: timespan
    - description: The number of entries per page returned. Acceptable range is 3
        - 1000. Default is 10.
      name: perPage
    description: Get Cisco meraki cloud managed  network clients
    name: panw-iot-3rd-party-cisco-meraki-get-network-clients
    outputs:
    - contextPath: cisco_meraki.network_clients
  - arguments:
    - description: Network ID
      name: networkID
      required: true
    description: Get Cisco meraki cloud managed  network devices
    name: panw-iot-3rd-party-cisco-meraki-get-network-devices
    outputs:
    - contextPath: cisco_meraki.network_devices
  dockerimage: demisto/panw-iot:1.0.0.79918
  runonce: false
  script: |
    register_module_line('PANW IoT 3rd Party Integration - Cisco Meraki Cloud', 'start', __line__())


    RATE_LIMIT_RESPONSE_CODE = 429
    INSTANCE_NAME = demisto.params().get('Name')
    LOG_PREFIX = 'PANW IoT 3rd Party Integration - Cisco Meraki Cloud : '+ str(INSTANCE_NAME)
    def initialize_instance(args: Dict[str, str], params: Dict[str, str]):
        global BASE_URL, API_KEY, USE_SSL, REST_API_HEADERS
        # SERVER_URL = 'https://api.meraki.com'
        SERVER_URL = str(params.get('url', '').rstrip("/"))
        BASE_URL = SERVER_URL + '/api/v1/'
        #API_KEY = str(params.get('key')) or str((params.get('credentials') or {}).get('password', ''))  # type: ignore
        API_KEY = str(params.get('apiKey'))

        if not API_KEY:
            raise Exception('API Key must be provided.')
        USE_SSL = not params.get('insecure')
        REST_API_HEADERS={}
        REST_API_HEADERS['X-Cisco-Meraki-API-Key']=API_KEY
        REST_API_HEADERS['Content-Type'] = 'application/json'

    def http_request(method, url_suffix, params=None, auth=None, data=None, headers=None):
        if headers is None:
            headers = REST_API_HEADERS
        if params is None:
            params = {}
        url = BASE_URL + url_suffix
        while True:
            try:
                response = requests.request(
                    method,
                    url,
                    headers=headers,
                    auth=auth,
                    verify=USE_SSL,
                    params=params,
                    data=data
                )
            except requests.exceptions.SSLError:
                err_msg = 'Could not connect to Cisco Meraki Cloud: Could not verify certificate.'
                demisto.error(f'{LOG_PREFIX} - {err_msg}')
                return_error(err_msg)
            except requests.exceptions.ConnectionError:
                err_msg = 'Connection Error. Verify that the Server URL and API Key are correct'
                demisto.error(f'{LOG_PREFIX} - {err_msg}')
                return_error(err_msg)
            except Exception as e:
                demisto.error(f'{LOG_PREFIX} - {str(e)}')
                demisto.error(traceback.format_exc())  # print the traceback
                return_error(f'Error:\n{str(e)}')
            else:
                # handle rate limit
                if response.status_code == RATE_LIMIT_RESPONSE_CODE:
                    retry_after = max(1, int(response.headers.get('Retry-After', 15)))
                    demisto.error(f'{LOG_PREFIX} - Rate Limit exceeded: retry after {retry_after}')
                    time.sleep(retry_after)
                    continue
                else:
                    break

        if response.status_code in {500,501,502,503}:
            demisto.error(f'{LOG_PREFIX} - Server error in API call to cisco meraki cloud -{response}')
            demisto.log('Server error in API call to cisco meraki cloud-'+str(response))
            return None
        # handle request failure
        if response.status_code not in {200, 201, 202, 204}:
            err_msg = f'Error in API call to Cisco Meraki cloud integration [{response.status_code}] - {response.json()}'
            demisto.error(f'{LOG_PREFIX} -'+err_msg)
            return_error(err_msg)

        try:
            response = response.json()
        except ValueError:
            demisto.error(f'{LOG_PREFIX} - Exception while getting json:'+str(response))
            print('Exception while getting json:'+str(response))
            return_error(f'error: {response}')
        return response

    def get_meraki_organizations(args):
        URL_SUFFIX='/organizations'
        organizations = http_request(method='GET', url_suffix=URL_SUFFIX)
        demisto.info(f'{LOG_PREFIX} organizations found: {organizations}')
        command_results = CommandResults(
            outputs_prefix='cisco_meraki.organizations',
            outputs=organizations
        )
        return command_results

    def get_meraki_networks(args):
        organizationID = args.get('organizationID')
        URL_SUFFIX='/organizations/' + organizationID + '/networks'
        networks = http_request(method='GET', url_suffix=URL_SUFFIX)
        demisto.info(f'{LOG_PREFIX} Networks found: {networks}')
        command_results = CommandResults(
            outputs_prefix='cisco_meraki.networks',
            outputs=networks
        )
        return command_results

    def get_meraki_network_clients(args):
        networkID = args.get('networkID')
        t0 = args.get('t0')
        timespan = args.get('timespan')
        perPage = args.get('perPage')
        params={}
        if t0:
            params['t0']=t0
        elif timespan:
            params['timespan']=timespan
        if perPage:
            params['perPage']=perPage

        URL_SUFFIX='/networks/'+networkID+'/clients'

        clients = http_request(method='GET', url_suffix=URL_SUFFIX, params=params)
        demisto.info(f'{LOG_PREFIX} clients found: {clients}')
        command_results = CommandResults(
            outputs_prefix='cisco_meraki.network_clients',
            outputs=clients
        )
        return command_results

    def get_meraki_network_devices(args):
        networkID = args.get('networkID')
        URL_SUFFIX='/networks/'+networkID+'/devices'
        devices = http_request(method='GET', url_suffix=URL_SUFFIX)
        demisto.info(f'{LOG_PREFIX} devices found for network {networkID} : {devices}')
        command_results = CommandResults(
            outputs_prefix='cisco_meraki.network_devices',
            outputs=devices
        )
        return command_results

    def test_connection(args):
        try:
            organizations = get_meraki_organizations(args)
        except DemistoException as e:
            raise e
        else:
            return 'ok'

    def main():
        try:
            args = demisto.args()
            params = demisto.params()
            handle_proxy()
            initialize_instance(args=args, params=params)
            command = demisto.command()
            if command == 'test-module':
                connection = test_connection(args)
                return_results(connection)
            elif command == 'panw-iot-3rd-party-cisco-meraki-get-organizations':
                return_results(get_meraki_organizations(args))
            elif command == 'panw-iot-3rd-party-cisco-meraki-get-networks':
                return_results(get_meraki_networks(args))
            elif command == 'panw-iot-3rd-party-cisco-meraki-get-network-clients':
                return_results(get_meraki_network_clients(args))
            elif command == 'panw-iot-3rd-party-cisco-meraki-get-network-devices':
                return_results(get_meraki_network_devices(args))
            else:
                raise NotImplementedError(f'Command {command} is not implemented.')
        except Exception as err:
                return_error(str(err), error=traceback.format_exc())

        finally:
            LOG.print_log()

    if __name__ in ["__builtin__", "builtins", '__main__']:
        main()

    register_module_line('PANW IoT 3rd Party Integration - Cisco Meraki Cloud', 'end', __line__())
  subtype: python3
  type: python
sourcemoduleid: Cisco Meraki
