category: Network Security
commonfields:
  id: PANW IoT 3rd Party Integration - cisco-dnac-IoT
  version: -1
configuration:
- display: Cisco DNA Center Server URL (e.g. https://sandboxdnac.cisco.com)
  name: url
  required: true
  type: 0
- display: Cisco DNA Center username
  name: credentials
  required: true
  type: 9
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- display: Long running instance
  name: longRunning
  required: false
  type: 8
- display: Incident type
  name: incidentType
  required: false
  type: 13
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    packName: ""
    prevname: ""
    propagationLabels:
    - all
    toServerVersion: ""
description: Cisco DNA Center Integration for Paloalto Networks IoT
display: PANW IoT 3rd Party Integration - cisco-dnac-IoT
image: data:image/png;base64,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
name: PANW IoT 3rd Party Integration - cisco-dnac-IoT
script:
  commands:
  - arguments: []
    description: Get DNAc Network Device
    name: dnac-network-device
    outputs:
    - contextPath: cisco-dnac-IoT.network_device
      description: network device list
      type: String
  - arguments: []
    description: Get DNAc Clients
    name: dnac-clients
    outputs:
    - contextPath: cisco-dnac-IoT.clients
      description: client list
      type: String
  - arguments:
    - description: client MAC address
      isArray: true
      name: client
      required: true
    description: Get DNAc Client Details
    name: dnac-client-detail
    outputs:
    - contextPath: cisco-dnac-IoT.client_detail
      description: client details
      type: String
  - arguments:
    - description: client mac address
      name: client
      required: true
    description: Get client enrichment details
    name: dnac-client-enrichment-detail
    outputs:
    - contextPath: cisco-dnac-IoT.client_enrichment_detail
      description: client enrichment details
      type: String
  dockerimage: demisto/panw-iot:1.0.0.79918
  longRunning: true
  runonce: false
  script: |
    register_module_line('PANW IoT 3rd Party Integration - cisco-dnac-IoT', 'start', __line__())


    import json
    import urllib3
    import requests
    import traceback
    from requests.auth import HTTPBasicAuth
    import time

    # Disable insecure warnings
    urllib3.disable_warnings()

    ''' CONSTANTS '''

    INVALID_TOKEN_RESPONSE_CODE = 401
    RATE_LIMIT_RESPONSE_CODE = 429
    BASE_URL = demisto.params().get('url')
    USERNAME = demisto.params().get('credentials').get('identifier')
    PASSWORD = demisto.params().get('credentials').get('password')
    LOG_PREFIX = 'PaloAltoNetworks3rdPartyIntegration_Cisco_DNAC'
    USE_SSL = not demisto.params().get('insecure', False)

    DEFAULT_HEADERS = {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Connection': 'keep_alive'
    }

    # Authentication
    AUTH_URL = '/dna/system/api/v1/auth/token'

    # URLs
    CLIENT_DETAIL = '/dna/intent/api/v1/client-detail'
    CLIENT_ENRICHMENT_DETAILS = '/dna/intent/api/v1/client-enrichment-details'
    #CLIENT_HEALTH = '/dna/intent/api/v1/client-health'
    CLIENT_HOST = '/api/assurance/v1/host'
    NETWORK_DEVICE = '/dna/intent/api/v1/network-device'
    #NETWORK_HEALTH = '/dna/intent/api/v1/network-health'
    #SITE_HEALTH = '/dna/intent/api/v1/site-health'

    dnac_token = None

    def http_request(method, url_suffix, params=None, auth=None, data=None, headers=None):
        if headers is None:
            headers = DEFAULT_HEADERS
        if params is None:
            params = {}
        url = BASE_URL + url_suffix
        while True:
            try:
                response = requests.request(
                    method,
                    url,
                    headers=headers,
                    auth=auth,
                    verify=USE_SSL,
                    params=params,
                    data=data
                )
            except requests.exceptions.SSLError:
                err_msg = 'Could not connect to Cisco DNA Center: Could not verify certificate.'
                demisto.error(f'{LOG_PREFIX} - {err_msg}')
                return_error(err_msg)
            except requests.exceptions.ConnectionError:
                err_msg = 'Connection Error. Verify that the Server URL and port are correct, and that the port is open.'
                demisto.error(f'{LOG_PREFIX} - {err_msg}')
                return_error(err_msg)
            except Exception as e:
                demisto.error(f'{LOG_PREFIX} - {str(e)}')
                demisto.error(traceback.format_exc())  # print the traceback
                return_error(f'Error:\n{str(e)}')
            else:
                # handle rate limit
                if response.status_code == RATE_LIMIT_RESPONSE_CODE:
                    retry_after = max(1, int(response.headers.get('Retry-After', 15)))
                    demisto.error(f'{LOG_PREFIX} - Rate Limit exceeded: retry after {retry_after}')
                    time.sleep(retry_after)
                    continue
                elif response.status_code == INVALID_TOKEN_RESPONSE_CODE and AUTH_URL != url_suffix:
                    demisto.error(f'{LOG_PREFIX} - refreshing access token')
                    dnac_token = get_dnac_jwt_token()
                    headers['X-Auth-Token'] = dnac_token
                    continue
                else:
                    break

        if response.status_code in {500,501,502,503}:
            demisto.error(f'{LOG_PREFIX} - Server error in API call to dnac-{response}')
            print('Server error in API call to dnac-'+str(response))
            return None
        # handle request failure
        if response.status_code not in {200, 201, 202, 204}:
            err_msg = f'Error in API call to Cisco DNA Center Integration [{response.status_code}] - {response.json()}'
            demisto.error(f'{LOG_PREFIX} -'+err_msg)
            print('Exception:'+err_msg)
            return_error(err_msg)

        try:
            response = response.json()
        except ValueError:
            demisto.error(f'{LOG_PREFIX} - Exception while getting json:'+str(response))
            print('Exception while getting json:'+str(response))
            return_error(f'error: {response}')

        return response

    # Get Authentication token
    def get_dnac_jwt_token():
        response = http_request('POST', AUTH_URL, auth=HTTPBasicAuth(USERNAME, PASSWORD))
        try:
            token = response['Token']
        except Exception:
            return_error(f'error: {response}')
        else:
            return token

    # Get network health
    def get_network_device(headers):
        response = http_request('GET', NETWORK_DEVICE, headers=headers)
        try:
            devices = response['response']
        except Exception:
            return response
        return CommandResults(
            outputs_prefix='cisco-dnac-IoT.network_device',
            outputs=devices
        )


    # Get clients
    def get_clients(headers):
        data={}
        response = http_request('POST', CLIENT_HOST, headers=headers, data=json.dumps(data))
        try:
            hosts = response['response']
        except Exception:
            return response
        return CommandResults(
            outputs_prefix='cisco-dnac-IoT.clients',
            outputs=hosts
        )

    # Get client detail
    def get_client_detail(headers):
        ms = demisto.args().get('client')

        res = []
        skipped_macs=[]
        for macs in ms:
            mac_address = macs['mac_list']
            timestamp = int(time.time() * 1000)
            params = {'timestamp': timestamp}
            count=0
            for mac in mac_address:
                params['macAddress'] = mac
                response = http_request('GET', CLIENT_DETAIL, headers=headers, params=params)
                time.sleep(0.5)
                if response is not None:
                    demisto.info(f'{LOG_PREFIX} - client details for mac={mac} is {response}')
                    res.append(response)
                else:
                    skipped_macs.append(mac)
                    demisto.info(f'{LOG_PREFIX} - client details skipped for mac={mac}')


        return CommandResults(
            readable_output=f'got {len(res)} client detail responses',
            outputs_prefix='cisco-dnac-IoT.client_detail',
            outputs_key_field='clients',
            outputs={
                'clients': res,
                'skipped_macs': skipped_macs
            }
        )

    # Get client enrichment detail
    def get_client_enrichment_detail(headers):
        mac_address = demisto.args().get('client')
        headers["entity_type"] = 'mac_address'
        headers["entity_value"] = mac_address
        response = http_request('GET', CLIENT_ENRICHMENT_DETAILS, headers=headers)
        return CommandResults(
            outputs_prefix='cisco-dnac-IoT.client_enrichment_detail',
            outputs=response[0]
        )

    ''' COMMAND FUNCTIONS '''

    def test_module() -> str:
        """
        :return: 'ok' if test passed, anything else will fail the test.
        :rtype: ``str``
        """
        try:
            token = get_dnac_jwt_token()
        except DemistoException as e:
            raise e
        else:
            return 'ok'


    ''' MAIN FUNCTION '''


    def main() -> None:
        """main function, parses params and runs command functions

        :return:
        :rtype:
        """
        global BASE_URL
        global dnac_token

        # get the service API url
        BASE_URL = demisto.params()['url']

        verify_certificate = not demisto.params().get('insecure', False)

        handle_proxy()

        cmd = demisto.command()
        demisto.info(f'Command being called is {cmd}')

        #if cmd == 'dnac-sites':
            #return_results(get_sites())

        try:
            if dnac_token == None:
                dnac_token = get_dnac_jwt_token()

            headers = {
                'X-Auth-Token': dnac_token,
                'Content-Type': 'application/json'
            }

            if cmd == 'test-module':
                # This is the call made when pressing the integration Test button.
                return_results(test_module())

            elif cmd == 'dnac-network-device':
                return_results(get_network_device(headers))

            elif cmd == 'dnac-clients':
                return_results(get_clients(headers))

            elif cmd == 'dnac-client-detail':
                return_results(get_client_detail(headers))

            elif cmd == 'dnac-client-enrichment-detail':
                return_results(get_client_enrichment_detail(headers))

        # Log exceptions and return errors
        except Exception as e:
            demisto.error(traceback.format_exc())  # print the traceback
            return_error(f'Failed to execute {demisto.command()} command.\nError:\n{str(e)}')

        finally:
            LOG.print_log()


    ''' ENTRY POINT '''


    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()

    register_module_line('PANW IoT 3rd Party Integration - cisco-dnac-IoT', 'end', __line__())
  subtype: python3
  type: python
sourcemoduleid: cisco-dnac-IoT
