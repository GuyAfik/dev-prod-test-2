category: Network Security
commonfields:
  id: PANW IoT 3rd Party Integration - Aruba ClearPass
  version: -1
configuration:
- display: Server URL
  name: url
  required: true
  type: 0
- display: Client ID
  name: client_id
  required: true
  type: 4
- display: Client Secret
  name: client_secret
  required: true
  type: 4
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    packName: ""
    prevname: ""
    propagationLabels:
    - all
    toServerVersion: ""
description: Aruba CP
display: PANW IoT 3rd Party Integration - Aruba ClearPass
image: data:image/png;base64,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
name: PANW IoT 3rd Party Integration - Aruba ClearPass
script:
  commands:
  - arguments:
    - description: 'MAC address of the endpoint (format: 11:22:33:44:55:66).'
      name: macAddress
      required: true
    description: Returns an endpoint ID, by its MAC address.
    name: aruba-clearpass-get-endpoint-id
    outputs:
    - contextPath: Endpoint.MACAddress
      description: Endpoint MACAddress.
      type: string
  - arguments:
    - description: MAC address of the endpoint (format 11:22:33:44:55:66).
      name: mac_address
      required: true
    - description: Attributes Map
      name: attributes_map
      required: true
    - description: integration context name
      name: context_name
    description: Updates the custom attributes of an endpoint.
    name: aruba-clearpass-update-endpoint
    outputs:
    - contextPath: ArubaCP.Update.Endpoint.MACAddress
      type: string
  - arguments:
    - description: Mac Address
      name: mac_address
      required: true
    - description: Attribute Map
      name: attributes_map
      required: true
    - description: context name of the integration
      name: context_name
    name: aruba-clearpass-create-endpoint
    outputs:
    - contextPath: ArubaCP.Endpoint.MACAddress
      description: Mac Address
      type: string
  - arguments:
    - description: access token context name with integration
      name: name
    name: aruba-clearpass-fetch-accesstoken
    outputs:
    - contextPath: ArubaCP.AccessToken
      description: Access Token
      type: string
  - arguments:
    - description: access token context name with integration
      name: name
    name: aruba-clearpass-get-accesstoken
    outputs:
    - contextPath: Aruba.Get.AccessToken
  - arguments:
    - description: Mac Address
      name: mac_address
    - description: A CSV list of attributes, for example, "attributeName=firstAttribute,secondAttribute".
      name: attributeName
      required: true
    - description: A CSV list of attribute values, for example, "attributeValue=firstValue,secondValue".
      name: attributeValue
    - description: Integration context name
      name: context_name
    name: aruba-clearpass-update-endpoint-custom-attribute
    outputs:
    - contextPath: ArubaCP.QUARANTINE_MSG
      description: quarantine/un-quarantine msg
  dockerimage: demisto/panw-iot:1.0.0.79918
  runonce: false
  script: |
    register_module_line('PANW IoT 3rd Party Integration - Aruba ClearPass', 'start', __line__())


    ''' IMPORTS '''
    import requests
    import re
    from urllib.parse import urlparse
    from oauthlib.oauth2 import BackendApplicationClient
    from requests_oauthlib import OAuth2Session

    # disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    ''' GLOBAL VARS '''

    SERVER_URL =  re.sub(r"/+$", "",demisto.params().get('url'))
    # SERVER_PORT = demisto.params().get('serverPort')

    CLIENT_ID = demisto.params().get('client_id')
    CLIENT_SECRET = demisto.params().get('client_secret')
    LOG_PREFIX='PaloAltoNetworks3rdPartyIntegration_Clearpass'

    USE_SSL = not demisto.params().get('insecure', False)

    BASE_PATH="/api/endpoint"

    DEFAULT_HEADERS = {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Connection': 'keep_alive'
    }
    ''' HELPER FUNCTIONS '''


    def http_request(method, url_suffix, params={}, data=None, headers=DEFAULT_HEADERS):
        try:
            url = SERVER_URL + url_suffix
            LOG(f'running {method} request with url={url}')

            response = requests.request(
                method,
                url,
                headers=headers,
                verify=USE_SSL,
                params=params,
                data=data
            )
        except requests.exceptions.SSLError:
            err_msg = 'Could not connect to Aruba ClearPass: Could not verify certificate.'
            return_error(err_msg)
        except requests.exceptions.ConnectionError:
            err_msg = 'Connection Error. Verify that the Server URL and port are correct, and that the port is open.'
            return_error(err_msg)
        # handle request failure
        if response.status_code not in {200, 201, 202, 204}:
            message = response
            err_msg = f'Error in API call to Aruba ClearPass Integration [{response.status_code}] - {response.reason}, {message}'

            return_error(err_msg)

        if response.status_code in (201, 204):
            return
        try:
            response = response.json()
        except ValueError:
            return_error(response.content)

        return response

    def is_expired(expires_at):
        if expires_at <= time.time():
            return True
        return False

    def get_access_token(context_name):
        try:
            aruba_context = demisto.get(demisto.context(), context_name)
            if aruba_context is not None:
                access_token_content = aruba_context[0]["Contents"]

                if access_token_content is not None:
                    access_token =  access_token_content.split(",")[0].split(":")[1].replace("\"","")
                    expires_at = access_token_content.split(",")[1].split(":")[1].replace("\"","").replace("}","")
                    if access_token is None or is_expired(float(expires_at)):
                        access_token_and_expires_at = fetch_access_token()
                        return access_token_and_expires_at
                    return access_token_content
            return fetch_access_token()
        except Exception as e:
            demisto.results("Error while getting access token::"+str(e))


    def fetch_access_token(context_name=None):
        try:
            access_token_and_expires={}
            api_endpoint = "/api/oauth"
            body={"grant_type":"client_credentials","client_id":CLIENT_ID,"client_secret":CLIENT_SECRET}
            try:
                inspector_client = BackendApplicationClient(client_id=CLIENT_ID)
                oauth = OAuth2Session(client=inspector_client)
                response = oauth.fetch_token(token_url=SERVER_URL+api_endpoint, client_id=CLIENT_ID,
                                      client_secret=CLIENT_SECRET, verify=False)

                access_token_and_expires["access_token"] = response["access_token"]
                access_token_and_expires["expires_at"] = str(response["expires_at"])
                return access_token_and_expires
            except Exception as e:
                return_error(str(e))
            return_error(str("exception while fetching the access_token"))
        except Exception as e:
            demisto.results("Error while fetching access token:"+str(e))

    def get_endpoint_id(mac_address=None):
        """
        Returns endpoint id by specific mac address
        """

        if mac_address is not None:
            api_endpoint = f'/ers/config/endpoint?filter=mac.EQ.{mac_address}'
        return http_request('GET', api_endpoint, '')

    def get_endpoint_id_command():
        """
        corresponds to 'aruba-clearpass-get-endpoint-id' command. Returns endpoint's id
        """
        mac_address = demisto.args().get('macAddress')

        if not is_mac_address(mac_address):
            return_error('Given MAC address is invalid')

        endpoint_data = get_endpoint_id(mac_address)
        endpoint_id = endpoint_data.get('SearchResult', {}).get('resources', [])[0].get('id', None)

        entry_context = {
            'Endpoint(val.ID === obj.ID)': {
                'ID': endpoint_id,
                'MACAddress': mac_address
            }
        }

        return_outputs(f'The endpoint ID is: {endpoint_id}', entry_context, endpoint_id)

    def update_endpoint():
        mac_address = demisto.args().get('mac_address')
        attr_map = demisto.args().get('attributes_map')
        demisto.info(f'{LOG_PREFIX} - updating mac_address={mac_address} and attr_map={attr_map}')
        context_name = demisto.args().get('context_name')
        access_token = demisto.get(demisto.context(), context_name)
        headers = {"Authorization": "Bearer " + access_token.strip()}
        if not is_mac_address(mac_address):
            return_error('Given MAC address is invalid')
        if attr_map is not None:
            attr_map = json.loads(attr_map)
        # profile = get_profile(mac_address,context_name)
        # return_outputs(profile)
        data = {
          "mac_address":mac_address,
          "status":"Known",
          "attributes": attr_map
        }
        api_endpoint = "/api/endpoint" + '/mac-address/'+mac_address
        # res = http_request('PATCH', api_endpoint, data=json.dumps(data), headers=headers)
        try:
            res = requests.patch(SERVER_URL+api_endpoint,
                            headers=headers, json=data, verify=USE_SSL)
        except requests.exceptions.SSLError:
            err_msg = 'Could not connect to Aruba ClearPass: Could not verify certificate.'
            demisto.error(f'{LOG_PREFIX} - {err_msg}')
            return_error(err_msg)
        except requests.exceptions.ConnectionError:
            err_msg = 'Connection Error. Verify that the Server URL and port are correct, and that the port is open.'
            demisto.error(f'{LOG_PREFIX} - {err_msg}')
            return_error(err_msg)
        # handle request failure
        if res.status_code in {404}:
            demisto.info(f'{LOG_PREFIX} - create new endpoint as the mac {mac_address} doesn\'t exists in the clearpass instance')
            return_error("CREATE_NEW_ENDPOINT")
        elif res.status_code in {403}:
            demisto.info(f'{LOG_PREFIX} - fetching new access token')
            return_error("FETCH_NEW_TOKEN")
        elif res.status_code not in {200, 201, 202, 204}:
            message = res.text
            err_msg = f'Error in API call to Aruba ClearPass Integration while updating [{res.status_code}] - {res.reason}, {message}'
            demisto.error(err_msg)
            return_error(err_msg)

        # return_outputs(f'The endpoint ID is: {endpoint_id}', entry_context, endpoint_id)
        endpoint_context = {
            'MACAddress': mac_address+":"+access_token,
        }

        context = {
             'ArubaCP.Update.Endpoint': endpoint_context
        }
        demisto.info(f'Endpoint "{mac_address}" has been updated successfully')
        return_outputs(f'Endpoint "{mac_address}" has been updated successfully', context)

    def create_endpoint():
        access_token=""
        mac_address = demisto.args().get('mac_address')
        attr_map = demisto.args().get('attributes_map')
        demisto.info(f'{LOG_PREFIX} - creating mac_address={mac_address} and attr_map={attr_map}')
        context_name = demisto.args().get('context_name')
        access_token = demisto.get(demisto.context(), context_name)
        headers = {"Authorization": "Bearer " + access_token.strip()}
        if not is_mac_address(mac_address):
            return_error('Given MAC address is invalid')
        if attr_map is not None:
            attr_map = json.loads(attr_map)
        # profile = get_profile(mac_address)
        data = {
          "mac_address":mac_address,
          "status":"Known",
          "attributes": attr_map
        }
        api_endpoint = "/api/endpoint"

        # res = http_request('POST', api_endpoint, data=json.dumps(data), headers=headers)
        try:
            res = requests.post(SERVER_URL+api_endpoint,
                            headers=headers, json=data, verify=USE_SSL)
        except requests.exceptions.SSLError:
            err_msg = 'Could not connect to Aruba ClearPass: Could not verify certificate.'
            return_error(err_msg)
        except requests.exceptions.ConnectionError:
            err_msg = 'Connection Error. Verify that the Server URL and port are correct, and that the port is open.'
            return_error(err_msg)
        # handle request failure
        if res.status_code in {403}:
            demisto.error(f'{LOG_PREFIX} - fetching new access token')
            return_error("FETCH_NEW_TOKEN")
        elif res.status_code in {422}:
            demisto.info(f'{LOG_PREFIX} - Updating PanwIoTProfile with unknown attribute')
            data["attributes"] = {"PanwIoTProfile": "Unknown"}
            res = requests.post(SERVER_URL+api_endpoint,
                            headers=headers, json=data, verify=USE_SSL)
        elif res.status_code not in {200, 201, 202, 204}:
            message = res
            err_msg = f'Error in API call to Aruba ClearPass Integration while creating endpoint [{res.status_code}] - {res.reason}, {message}'
            demisto.error({LOG_PREFIX}+' - '+err_msg)
            return_error(err_msg)
        endpoint_context = {
            'MACAddress': mac_address,
        }

        context = {
             'ArubaCP.Endpoint.MACAddress':endpoint_context
        }
        demisto.info(f'{LOG_PREFIX} - Endpoint "{mac_address}" has been created successfully')
        return_outputs(f'Endpoint "{mac_address}" has been created successfully', context)

    def fetch_access_token_command():
        access_token_name = demisto.args().get('name')
        access_token = fetch_access_token(access_token_name)
        return CommandResults(
            readable_output=f'got auth response{access_token}',
            outputs_prefix='Aruba.Get.AccessToken',
            outputs=access_token
        )

    def get_access_token_command():
        access_token_name = demisto.args().get('name')
        access_token = get_access_token(access_token_name)
        return CommandResults(
            readable_output=f'got auth response{access_token}',
            outputs_prefix='ArubaCP.AccessToken',
            outputs=access_token
        )

    def get_profile(mac_str,context_name):
        result = get_insight_endpoint(mac_str,context_name)
        if result == None:
            return "Unknown"
        try:
            profile = result["device_name"]
            if profile == "":
                return "Unknown"
            return profile
        except Exception as ex:
            return "Unknown"


    def get_insight_endpoint(mac_str,context_name):
        mac_str = format_mac_str(mac_str)

        access_token = demisto.get(demisto.context(), context_name)
        headers = {"Authorization": "Bearer "+access_token.strip(), "Accept": "application/json"}
        try:
            insight_endpoint = "/api/insight/endpoint/"
            r = requests.get(SERVER_URL+insight_endpoint + 'mac/' + mac_str, headers=headers, verify=False)
        except Exception as ex:
            # print >> sys.stderr, "Error getting insight endpoint: %s" % (str(ex))
            LOG("Error getting insight endpoint: %s" % (str(ex)))
            return None

        if r.status_code == 404:
            return None

        if r.status_code != 200:
            # print >> sys.stderr, 'Got error code %d when getting insight endpoint %s: %s' % (r.status_code, mac_str, str(r))
            LOG('Got error code %d when getting insight endpoint %s: %s' % (r.status_code, mac_str, str(r)))
            return None
        return r.json()

    def format_mac_str(mac_str):
        nibbles = mac_str.split(':')
        return ''.join(nibbles)

    def test_module() -> str:
        """
        :return: 'ok' if test passed, anything else will fail the test.
        :rtype: ``str``
        """
        try:
            token = fetch_access_token()
        except Exception as e:
            raise e
        else:
            return 'ok'

    def update_endpoint_custom_attribute_command():
        api_endpoint = "/api/endpoint"
        aruba_endpoint_base_url=SERVER_URL+api_endpoint
        endpoint_mac_address = demisto.args().get('mac_address')
        demisto.info(f'{LOG_PREFIX} - updating custom attributes for  mac_address={endpoint_mac_address}')

        context_name = demisto.args().get('context_name')
        acc_token = get_access_token(context_name)
        if isinstance(acc_token,dict) :
            acc_token=acc_token["access_token"]
        headers = {"Authorization": "Bearer " + acc_token}

        if endpoint_mac_address and not is_mac_address(endpoint_mac_address):
            demisto.error(f'{LOG_PREFIX}-Please enter a valid mac address={endpoint_mac_address}')
            return_error('Please enter a valid mac address')
        attributes_dic={}
        attribute_names = demisto.args().get('attributeName').split(',')
        attribute_values = demisto.args().get('attributeValue').split(',')
        demisto.info(f'{LOG_PREFIX} - attribute_names={attribute_names} and  attribute_values={attribute_values} for mac={endpoint_mac_address}')
        isQuarantine = is_quarantine(attribute_values)
        quarantine_msg = ""
        unset = False
        if isQuarantine:
            unset=False
            quarantine_msg=""
        else:
            unset=True
            quarantine_msg="Un-Quarantine"
        for couple in zip(attribute_names, attribute_values):
            attributes_dic[couple[0]] = couple[1]

        session_base_url=SERVER_URL+"/api/session"
        result = update_endpoint_api(headers, aruba_endpoint_base_url, endpoint_mac_address, attributes_dic, unset)

        if result is None:
            # return_error("Error quarantine/un-quarantine by clearpass when setting attributes")
            demisto.error(f'{LOG_PREFIX} -Error {quarantine_msg} by clearpass when setting attributes. please check the custom fields are defined in the system')
            demisto.results("Error "+ quarantine_msg+" by clearpass when setting attributes. please check the custom fields are defined in the system."+ str(acc_token))

        if result is not None and 'status' in result and result['status'] == "not found":
            msg = quarantine_msg+" Successfully, updated the endpoint "+endpoint_mac_address+" and its fields:" + str(attributes_dic)
            demisto.info(f'{LOG_PREFIX} - {msg}')
            return_results(msg)

        status = disconnect_sessions_by_mac(session_base_url, headers, endpoint_mac_address)

        if status:
            msg=quarantine_msg+ ' successfully updated endpoint '+ endpoint_mac_address+" and its fields:"+ str(attributes_dic)
            demisto.info(f'{LOG_PREFIX} - {msg}')
            return_results(msg)
        else:
            # demisto.results(quarantine_msg+ " failed for %s: %s" % (endpoint_mac_address, str(msg)))
            demisto.info(f'{LOG_PREFIX} - {quarantine_msg} failed for {endpoint_mac_address}')
            return_results(quarantine_msg+ " failed for %s" % (endpoint_mac_address))

    def is_quarantine(attr_arr):
        str_arr="".join(attr_arr)
        if not str_arr:
            return False
        else:
            return True

    def disconnect_sessions_by_mac(session_base_url, headers,endpoint_mac_address):
        endpoint_mac_address = format_mac_str(endpoint_mac_address)
        headers["Accept"]="application/json"
        params = {"filter": json.dumps({"mac_address": endpoint_mac_address})}
        try:
            r = requests.get(session_base_url, headers = headers,
                             params = params, verify = USE_SSL)
        except Exception as ex:
            demisto.error(f'{LOG_PREFIX} - Error getting endpoint session: {str(ex)}')
            return False, str(ex)
            # return False

        if r.status_code == 404:
            demisto.error(f'{LOG_PREFIX} - No active session found for endpoint {endpoint_mac_address}')
            return True, r.text
            # return True
        if r.status_code != 200 and r.status_code != 201:
            return False, r.text
            # return False
        return True, r.text

    def update_endpoint_api(headers,endpoint_base_url, mac_str, attributes, is_unset=False):
        mac_str = format_mac_str(mac_str)
        headers["Content-Type"] = "application/json"
        data = {"mac_address": mac_str, "status":"Known", "attributes": attributes}
        try:
            # use PATCH instead of PUT to only update specific attributes
            r = requests.patch(endpoint_base_url + '/mac-address/' + mac_str,
                               headers = headers, json = data, verify = USE_SSL)
        except Exception as ex:
            demisto.error(f'{LOG_PREFIX} - Error updating endpoint:{str(ex)}')
            return None
        # create it if not there (so we are not allowed to PUT)
        if r.status_code == 405 or r.status_code == 404:
            if is_unset:
                demisto.error(f'{LOG_PREFIX} - endpoint not existing')
                return {"status":"not found"}

            #print "endpoint not existing, creating it first"
            demisto.info(f'{LOG_PREFIX} - endpoint not existing, creating it first')
            try:
                r = requests.post(endpoint_base_url,
                                  headers = headers, json = data, verify = USE_SSL)
                # demisto.results(r.status_code)
            except Exception as ex:
                #print >> sys.stderr, "Error creating endpoint: %s" % (str(ex))
                demisto.info(f'{LOG_PREFIX} - Error creating endpoint : {str(ex)}')
                return None

        if is_unset and r.status_code == 422:
            #not alowed to have empty "attributes" block , put a dummy profile attribute
            data["attributes"] = {"ZingboxProfile": "Unknown"}
            try:
                r = requests.put(endpoint_base_url + '/mac-address/' + mac_str,
                                 headers = headers, json = data, verify = USE_SSL)
            except Exception as ex:
                #print >> sys.stderr, "Error unsetting endpoint attributes: %s" % (str(ex))
                demisto.info(f'{LOG_PREFIX} - Error unsetting endpoint attributes: {str(ex)}')
                return None

        if r.status_code != 200 and r.status_code != 201:
            #print >> sys.stderr, 'Got error code %d when updating endpoint %s: data: %s, %s' % (r.status_code, mac_str, json.dumps(data), str(r))
            demisto.error(f'{LOG_PREFIX} - Got error code {r.status_code} when updating endpoint {mac_str}: data: {json.dumps(data)}, response={r}')
            return None
        return r.json()

    def main():

        LOG('Command being called is %s' % (demisto.command()))
        try:
            handle_proxy()
            if demisto.command() == 'test-module':
                return_results(test_module())
            elif demisto.command() == 'aruba-clearpass-get-endpoint-id':
                return_results(get_endpoint_id_command())
            elif demisto.command() == 'aruba-clearpass-update-endpoint':
                return_results(update_endpoint())
            elif demisto.command() == 'aruba-clearpass-create-endpoint':
                return_results(create_endpoint())
            elif demisto.command() == 'aruba-clearpass-fetch-accesstoken':
                return_results(fetch_access_token_command())
            elif demisto.command() == 'aruba-clearpass-get-accesstoken':
                return_results(get_access_token_command())
            elif demisto.command() == 'aruba-clearpass-update-endpoint-custom-attribute':
                update_endpoint_custom_attribute_command()

        except Exception as e:
            return_error(str(e))

    # python2 uses __builtin__ python3 uses builtins
    if __name__ == "__builtin__" or __name__ == "builtins":
        main()

    register_module_line('PANW IoT 3rd Party Integration - Aruba ClearPass', 'end', __line__())
  subtype: python3
  type: python
sourcemoduleid: Aruba ClearPass
