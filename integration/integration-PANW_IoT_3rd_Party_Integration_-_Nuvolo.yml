category: Network Security
commonfields:
  id: PANW IoT 3rd Party Integration - Nuvolo
  version: -1
configuration:
- display: Nuvolo Server URL (e.g. https://ven123.service-now.com/)
  name: url
  required: true
  type: 0
- display: A source key associated with the vendor data source within Nuvolo
  name: source_key
  required: true
  type: 4
- display: Username
  name: username
  required: true
  type: 4
- display: Password
  name: password
  required: true
  type: 4
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: ""
    itemVersion: ""
    packID: ""
    packName: ""
    prevname: ""
    propagationLabels:
    - all
    toServerVersion: ""
description: Nuvolo Integration for Palo Alto Networks IoT
display: PANW IoT 3rd Party Integration - Nuvolo
image: data:image/png;base64,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
name: PANW IoT 3rd Party Integration - Nuvolo
script:
  commands:
  - arguments:
    - description: Unique identifier for the asset.
      name: asset_id
      required: true
    - auto: PREDEFINED
      description: It's used to specify the Nuvolo table name.
      name: table_name
      predefined:
      - x_nuvo_eam_clinical_devices
      - x_nuvo_eam_facilities_devices
      - x_nuvo_eam_lab_devices
      - x_nuvo_eam_unmatched_devices
      required: true
    - description: Providing additional descriptive data intended to provide context
        or additional data about the event.
      name: payload
      required: true
    - description: A parameters array of objects containing all relevant device data
        from PANW IoT cloud side to identify the asset.
      isArray: true
      name: parameters
      required: true
    - auto: PREDEFINED
      description: Type of Asset.
      name: asset_type
      predefined:
      - device
      - alert
      - vulnerability
      required: true
    - description: Nuvolo required attribute.
      isArray: true
      name: device_identifiers
    description: Asset inventory population or updating asset parameters
    name: nuvolo-create-record
    outputs:
    - contextPath: Nuvolo-IoT.resp
      description: Response from Nuvolo.
  - arguments:
    - description: A list of mac address list.
      isArray: true
      name: mac_address_list
      required: true
    description: Get asset details from Nuvolo.
    name: nuvolo-get-record
    outputs:
    - contextPath: Nuvolo-IoT.pullResp
      description: Pulled device lists.
  dockerimage: demisto/panw-iot:1.0.0.79918
  runonce: false
  script: |
    register_module_line('PANW IoT 3rd Party Integration - Nuvolo', 'start', __line__())


    import base64
    import urllib3
    import uuid
    # Disable insecure warnings
    urllib3.disable_warnings()

    BASE_URL = demisto.params().get('url')
    GET_NUVOLO_ASSET_URI = "api/x_nuvo_cs/otcs/getAssetProfiles"
    SOURCE_KEY = demisto.params().get('source_key')
    USERNAME = demisto.params().get('username')
    PASSWORD = demisto.params().get('password')
    CREDS = (f'{USERNAME}:{PASSWORD}')
    CREDS_BYTES = CREDS.encode("ascii")
    BASE64_CREDS_BYTES = base64.b64encode(CREDS_BYTES)
    BASE64_CREDS = BASE64_CREDS_BYTES.decode("ascii")
    DEFAULT_HEADERS = {
        'Content-Type': 'application/json',
        'Authorization': f'Basic {BASE64_CREDS}'
    }

    def http_request(method, url_suffix, params = None, data = None):
        if params is None:
            params = {}
        url = BASE_URL + url_suffix
        try:
            LOG(f'running {method} request with url = {url}')
            response = requests.request(method, url, headers=DEFAULT_HEADERS, params=params, data=data)
        except requests.exceptions.ConnectionError as e:
            err_msg = f'Failed to connect to Nuvolo. Verify username, password, source_key and url are correct. {e}'
            raise requests.exceptions.ConnectionError(err_msg)
        if response.status_code not in {200, 201, 202, 204}:
            # There will be a case that a list of mac querying to Nuvolo doesn't exist. But status code shouldn't be 500.
            # This is a turn around.
            if url_suffix == GET_NUVOLO_ASSET_URI:
                if response.content.decode('utf-8').find("Device Not Found") != -1:
                    return 'Device Not Found'
            err_msg = f'Error in API call to Nuvolo  [{response.status_code}] - {response.reason}.'
            raise Exception(err_msg)

        if response.status_code in (201, 204):  # 201-Created OR 204-No Content
            return
        try:
            response = response.json()
        except ValueError:
            err_msg = f'Failed to parse ouput for API call {url}'
            raise ValueError(err_msg)

        return response

    def connection_test_command() -> str:
        """
        Test connection using Nuvolo provided connection testing endpoint
        """
        data = {
            'source_key': SOURCE_KEY
        }
        url_suffix = "api/x_nuvo_cs/otcs/testCredentials"
        http_request('POST', url_suffix, None, json.dumps(data))

        return 'ok'

    def get_asset_data(args):
        """
        Get assets from Nuvolo based on the Mac address list.
        """
        mac_address_list = args.get('mac_address_list')
        data = {
            'source_key': SOURCE_KEY,
            'device_identifiers': []
        }
        for mac in mac_address_list:
            data['device_identifiers'].append({'mac_address': mac})

        resp = http_request('POST', GET_NUVOLO_ASSET_URI, None, json.dumps(data))
        if resp == 'Device Not Found':
            resp = {
                'result': {
                    "message": f'Processed all {len(mac_address_list)} of the requested items. None of the requested items were successful.',
                    'results': [
                        {
                            "status": "Device Not Found",
                            "status_code": 500
                        }
                    ]
                }
            }

        return CommandResults(
            readable_output= resp['result']['message'],
            outputs_prefix = 'Nuvolo-IoT.pullResp',
            outputs = {
                "resp": resp['result']['results']
            })


    def send_asset_data(args):
        """
        Send assets to Nuvolo based on the different asset_type.
        """
        table_name = args.get('table_name')
        parameters = args.get('parameters')
        payload = args.get('payload')
        asset_type = args.get('asset_type')
        if asset_type == 'device':
            device_id = args.get('asset_id')
            data = {
                'source_key': SOURCE_KEY,
                'device_id': device_id,
                'payload': 'Discovery Event',
                'parameters': parameters,
                'table_name': table_name
            }

            url_suffix = "api/x_nuvo_cs/otcs/createDiscoveryQueue"
            resp = http_request('POST', url_suffix, None, json.dumps(data))
            return CommandResults(
                readable_output='Successfully sending devices to Nuvolo',
                outputs_prefix = 'Nuvolo-IoT.resp',
                outputs = {
                    "resp": resp['result']['message']
                })


        elif asset_type == 'alert' or asset_type == 'vulnerability':
            transaction_id = args.get('asset_id')
            device_identifiers = args.get('device_identifiers')
            event_id = str(uuid.uuid4())
            data = {
                'source_key': SOURCE_KEY,
                'event_id': event_id,
                'transaction_id': transaction_id,
                'payload': payload,
                'parameters': parameters,
                'table_name': table_name,
                'device_identifiers': device_identifiers
            }
            url_suffix = "api/x_nuvo_cs/otcs/createSecurityQueue"
            resp = http_request('POST', url_suffix, None, json.dumps(data))
            op_data = {
                "Response": resp['result']['message']
            }
            return CommandResults(
                readable_output=tableToMarkdown("Alert Sending Nuvolo Response:", op_data, removeNull=True),
                outputs_prefix = 'Nuvolo-IoT.resp',
                outputs = {
                    "resp": resp['result']['message']
                })


    def main() -> None:
        """
        main function, parses args and runs command functions
        """
        command = demisto.command()
        args = demisto.args()
        demisto.debug(f'Command being called is {command}')
        try:
            if command == 'test-module':
                return_results(connection_test_command())
            elif command == 'nuvolo-create-record':
                results = send_asset_data(args)
                return_results(results)
            elif command == 'nuvolo-get-record':
                results = get_asset_data(args)
                return_results(results)

        except Exception as e:
            demisto.error(traceback.format_exc())  # print the traceback
            return_error(f'Failed to execute {demisto.command()} command.\nError:\n{str(e)}. Arguments: {args}')


    ''' ENTRY POINT '''
    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()


    register_module_line('PANW IoT 3rd Party Integration - Nuvolo', 'end', __line__())
  subtype: python3
  type: python
sourcemoduleid: Nuvolo
